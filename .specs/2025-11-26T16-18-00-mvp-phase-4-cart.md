# MVP Implementation Plan - yeoldeartoonist.com

**Date:** 2025-10-25
**Duration:** 6 weeks
**Status:** In Progress (Phases 1-3 Complete, Phase 4 Starting)

---

## Overview

This document outlines the detailed implementation phases for building yeoldeartoonist.com MVP. It integrates all architectural decisions made and provides clear, actionable steps for each phase.

**Tech Stack (Finalized):**

- Next.js 14 + TypeScript + Tailwind CSS
- Supabase (Database + Auth + Storage)
- Stripe (Payment processing with all standard methods)
- Resend (Transactional emails)
- Vercel (Hosting)
- Porkbun domain (DNS)

**Key Decisions:**

- ✅ Payments: Stripe (cards, Apple Pay, Google Pay, Link)
- ✅ Shipping: Flat rate ($5.00)
- ✅ Tax: Stripe Tax
- ✅ Email: Resend
- ✅ Hosting: Vercel + Porkbun DNS

**Additional References**

For additional details on this project refer to these documents:

- @specs\architecture-plan.md
- @specs\architecture-summary.md
- @specs\2025-10-25T11-09-00-initial-plan-discussion.md

---

## Phase 4: Shopping Cart & Checkout (Week 5)

### Goal

Implement complete shopping cart with localStorage persistence, checkout form, and Stripe payment integration.

### Critical Testing Infrastructure Gaps

Phase 4 features will be developed using Test Driven Development (TDD) using the Red/Green/Refactor pattern. Features will not be added until a failing test exists describing the feature. Where existing testing gaps are discovered, add tests for those features.

Before implementing Phase 4 features, review the following testing infrastructure issues from Phase 2.5. Determine if they will be addressed in the course of implementing the Phase 4 features. If not, we must address them prior to beginning work on Phase 4 to ensure those features can be reasonably tested.

#### 4.0.1 Cart Hook Tests Missing

**Issue**: `hooks/useCart.ts` has 0% test coverage but is critical Phase 4 logic.

**Blockers for Phase 4**:

- Cannot test checkout flow without understanding cart behavior
- Cannot verify cart persistence across sessions
- Edge cases and error handling untested

**Required Before Phase 4**:

- Add comprehensive tests for `hooks/useCart.ts`:
    - Adding items to cart
    - Removing items from cart
    - Updating quantities
    - Clearing cart
    - Calculating totals (subtotal, shipping, tax)
    - Cart persistence in localStorage
    - Edge cases: duplicate items, large quantities, inventory limits
    - localStorage quota exceeded handling
    - Malformed localStorage data recovery
    - Session expiry and cache invalidation

#### 4.0.2 CartContext Tests Missing

**Issue**: `src/context/CartContext.tsx` has 0% test coverage.

**Blockers for Phase 4**:

- Cart context provides global state for all cart operations
- Cannot safely refactor cart logic without tests
- Race conditions and state management edge cases untested

**Required Before Phase 4**:

- Add tests for `src/context/CartContext.tsx`:
    - Context provider initialization
    - Adding items to cart (new and duplicate)
    - Removing items from cart
    - Updating quantities
    - Clearing cart
    - Provider hook (useCart) works correctly
    - Multiple component subscribers stay in sync
    - Edge cases: concurrent updates, rapid add/remove cycles

#### 4.0.3 Cart Components Lack Real Tests

**Issue**: Cart UI components (CartButton, CartDrawer, CartItem, CartSummary) need tests but may be insufficient.

**Blockers for Phase 4**:

- Cannot test checkout UI without validating cart display
- Drawer open/close animations untested
- Item quantity editor behavior untested

**Required Before Phase 4**:

- Add tests for cart components:
    - CartButton displays correct item count
    - CartDrawer opens/closes correctly
    - CartItem shows correct item details
    - CartItem quantity editor works
    - CartItem remove button deletes item
    - CartSummary calculates totals correctly
    - Integration: components work together

#### 4.0.4 Stripe Integration Tests Missing

**Issue**: Stripe payment integration tests likely missing or insufficient.

**Blockers for Phase 4**:

- Cannot test payment flow without Stripe tests
- Card validation, error handling untested
- Webhook handling untested
- Payment intent creation untested

**Required Before Phase 4**:

- Add tests for Stripe integration:
    - Payment intent creation with correct amounts
    - Stripe Elements rendering and validation
    - Card error handling
    - Payment submission flow
    - Webhook signature verification
    - Failed payment handling
    - Idempotency key handling (prevent duplicate charges)

#### 4.0.5 Checkout Form Validation Tests

**Issue**: Checkout form validation (address, email, etc.) needs real tests.

**Blockers for Phase 4**:

- Cannot trust form submission without validation tests
- Price tampering vulnerability untested
- Inventory validation untested

**Required Before Phase 4**:

- Add tests for checkout form:
    - Address validation (required fields, format)
    - Email validation
    - Billing vs shipping address toggle
    - Price display matches cart
    - Inventory checks before submission
    - Cart validation (published items, inventory)
    - Form error messages
    - Success/error state handling

#### 4.0.6 Order Creation & Database Tests

**Issue**: Order creation and database queries for orders untested.

**Blockers for Phase 4**:

- Cannot verify orders are created correctly
- Inventory decrement untested
- Order numbering untested
- Order history untested

**Required Before Phase 4**:

- Add tests for `src/lib/db/orders.ts`:
    - Create order with correct data
    - Order number generation and uniqueness
    - Inventory decrement on order creation
    - Error handling for invalid orders
    - Retrieve order by ID
    - Update order status
    - List orders with pagination/filtering
- Mock Supabase for realistic testing

#### 4.0.7 E2E Checkout Flow Tests

**Issue**: End-to-end checkout flow (cart → checkout → payment → confirmation) untested.

**Blockers for Phase 4**:

- Cannot verify complete user journey
- Race conditions between cart and payment untested
- Session persistence during checkout untested

**Required Before Phase 4**:

- Add E2E tests for complete checkout flow:
    - Add items to cart
    - Navigate to cart page
    - Update quantities
    - Proceed to checkout
    - Fill form with valid data
    - Submit payment
    - Verify success page
    - Verify order in database
    - Verify inventory decremented
    - Verify email sent (mock)

### Summary

**Phase 4 cannot proceed until these testing gaps are filled.** Shopping cart and checkout are mission-critical features handling payments and customer data. Thorough testing is essential to prevent lost sales and security issues.

### Tasks

Phase 4 features will be developed using Test Driven Development (TDD) using the Red/Green/Refactor pattern. Features will not be added until a failing test exists describing the feature. Where existing testing gaps are discovered, add tests for those features.

#### 4.1 Cart State Management

Using TDD, implement these features:

- [ ] Create `src/lib/cart/storage.ts` - localStorage cart management
- [ ] Create `src/hooks/useCart.ts` - Cart hook for components
- [ ] Create `src/context/CartContext.tsx` - React Context for global cart state
- [ ] Implement cart operations:
    - Add item to cart
    - Remove item from cart
    - Update quantity
    - Clear cart
    - Calculate subtotal

#### 4.2 Cart UI Components

Using TDD, implement these features:

- [ ] Create `src/components/cart/CartButton.tsx` - Header cart icon with count
- [ ] Create `src/components/cart/CartDrawer.tsx` - Slide-out cart panel
- [ ] Create `src/components/cart/CartItem.tsx` - Individual item in cart
- [ ] Create `src/components/cart/CartSummary.tsx` - Cart totals summary
- [ ] Add "Add to Cart" functionality on Shoppe page
- [ ] Add cart drawer to header (visible on all pages)
- [ ] Implement smooth animations for drawer open/close

#### 4.3 Cart Page

Using TDD, implement these features:

- [ ] Create `src/app/shoppe/cart/page.tsx` - Dedicated cart page
- [ ] Display all cart items with:
    - Item thumbnail
    - Title and price
    - Quantity editor
    - Remove button
    - Line subtotal
- [ ] Display cart summary (subtotal, shipping estimate, tax estimate)
- [ ] "Continue Shopping" and "Checkout" buttons
- [ ] Empty cart state message
- [ ] Responsive design

#### 4.4 Checkout Form

Using TDD, implement these features:

- [ ] Create `src/app/shoppe/checkout/page.tsx` - Checkout page
- [ ] Create `src/components/checkout/CheckoutForm.tsx` - Main form
- [ ] Create `src/components/checkout/AddressForm.tsx` - Address fields
- [ ] Create `src/components/checkout/PaymentForm.tsx` - Stripe payment element
- [ ] Form fields:
    - Customer name and email
    - Shipping address (address line 1, line 2, city, state, zip, country)
    - Billing address (with "Same as shipping" option)
    - Order notes (optional)
- [ ] Form validation with Zod schema
- [ ] Show order summary on right side

#### 4.5 Stripe Integration

Using TDD, implement these features:

- [ ] Create `src/lib/payments/stripe.ts` - Stripe client setup
- [ ] Create `src/app/api/checkout/route.ts` - POST endpoint to create payment intent
- [ ] Install Stripe Elements components
- [ ] Implement Stripe Payment Element in checkout form
- [ ] Handle payment submission and client secret
- [ ] Add error handling for payment failures
- [ ] Add loading states during payment processing

#### 4.6 Cart Validation

Using TDD, implement these features:

- [ ] Create `src/lib/cart/validation.ts` - Server-side cart validation
- [ ] Validate cart items against database before checkout:
    - Verify items exist and are published
    - Verify prices match (catch tampering)
    - Verify inventory available
    - Check quantities
- [ ] Calculate accurate totals:
    - Subtotal from item prices
    - Shipping ($5.00 flat rate)
    - Tax via Stripe Tax API
- [ ] Return validated cart or error

#### 4.7 Order Creation

Using TDD, implement these features:

- [ ] Create `src/lib/db/orders.ts` - Order database functions
- [ ] Create order in database on successful payment intent
- [ ] Store order with:
    - Order number (auto-generated)
    - Customer info
    - Shipping/billing addresses
    - Cart items as order_items
    - Totals (subtotal, shipping, tax)
    - Payment intent ID
    - Order status (pending)
- [ ] Decrement inventory on successful payment

#### 4.8 Stripe Webhook

Using TDD, implement these features:

- [ ] Create `src/app/api/checkout/webhook/route.ts` - Webhook handler
- [ ] Listen for `payment_intent.succeeded` event
- [ ] Verify webhook signature
- [ ] Update order status to "paid" when payment succeeds
- [ ] Handle `payment_intent.payment_failed` for failed payments
- [ ] Log all webhook events for debugging

#### 4.9 Order Confirmation

Using TDD, implement these features:

- [ ] Create `src/app/shoppe/checkout/success/page.tsx` - Success page
- [ ] Display:
    - Order confirmation message
    - Order number
    - Order total
    - Shipping address
    - Note: Email sent (when Resend integrated)
    - Link back to gallery
- [ ] Send confirmation email via Resend (integrate later)
- [ ] Clear cart after successful payment

#### 4.10 Error Handling

Using TDD, implement these features:

- [ ] Create `src/app/shoppe/checkout/cancelled/page.tsx` - Cancelled page
- [ ] Handle payment cancellation
- [ ] Handle validation errors
- [ ] Handle Stripe errors
- [ ] Add user-friendly error messages
- [ ] Log errors for admin review

### Deliverables

- ✅ Complete shopping cart with persistence
- ✅ Checkout form with validation
- ✅ Stripe payment integration
- ✅ Order database storage
- ✅ Webhook handling for payment confirmation
- ✅ Order confirmation page

### Verification Checklist

- [ ] Add item to cart from Shoppe page
- [ ] Cart persists when refreshing page
- [ ] Cart drawer shows correct count
- [ ] Checkout form validates addresses
- [ ] Stripe payment element appears in checkout
- [ ] Test payment succeeds with Stripe test card
- [ ] Order created in database with correct totals
- [ ] Webhook confirms payment
- [ ] Success page shows order details
- [ ] Inventory decremented after payment
