# Implementation Plan: Allow Uploading Images Larger Than 1MB

**GitHub Issue:** #35
**Created:** 2025-11-27T11:51:09
**Status:** Pending Approval

---

## Overview

Next.js has a default Server Action body size limit of 1MB. Users attempting to upload images larger than 1MB receive an error message pointing to the Next.js configuration documentation. We need to increase this limit to 10MB to match our existing upload validation logic.

### Goals and Success Criteria

- ✅ Configure Next.js to accept Server Action payloads up to 10MB
- ✅ Maintain existing 10MB validation in upload action
- ✅ Verify all existing tests pass
- ✅ No changes to security or authentication logic
- ✅ No breaking changes to existing upload workflow

### Estimated Scope and Complexity

**Complexity:** Low
**Rationale:** This is a simple configuration change with minimal code impact. The application already validates files up to 10MB on both client and server sides. We're simply removing a framework-level restriction that's more conservative than our application's requirements.

---

## Technical Approach

### Architectural Decisions and Rationale

#### Decision 1: Set bodySizeLimit to 10MB

**Rationale:**

- Application already validates and accepts images up to 10MB (`MAX_FILE_SIZE` in `src/app/admin/actions/upload.ts:7`)
- ImageUploader component defaults to 10MB limit (`DEFAULT_MAX_SIZE_MB` in `src/components/admin/ImageUploader.tsx:19`)
- Tests verify 10MB limit enforcement (`__tests__/app/admin/actions/upload.test.ts:222-234`)
- Consistency: Framework limit should match application limits

#### Decision 2: Use '10mb' String Format

**Rationale:**

- More readable than numeric bytes (10485760)
- Supported by Next.js bytes library
- Consistent with Next.js documentation examples
- Self-documenting configuration value

#### Decision 3: Add to experimental.serverActions Configuration

**Rationale:**

- Next.js 15/16 places this setting under `experimental.serverActions`
- Follows official Next.js documentation pattern
- Future-proof: Will migrate to stable API when available

### Design Patterns

This change follows the **Configuration Pattern**:

- Centralized configuration in `next.config.ts`
- Single source of truth for framework-level settings
- No code changes required in application logic

### Integration Points

**Files Modified:**

- `next.config.ts` - Add serverActions configuration

**Files Verified (No Changes Required):**

- `src/app/admin/actions/upload.ts` - Already validates 10MB limit
- `src/components/admin/ImageUploader.tsx` - Already enforces 10MB client-side
- `__tests__/app/admin/actions/upload.test.ts` - Already tests 10MB limit

### SOLID Principles Application

#### Single Responsibility Principle (SRP)

- **Applied:** Configuration concerns separated from business logic
- **How:** Framework limits in `next.config.ts`, application validation in upload action
- **Benefit:** Each file has one reason to change

#### Open/Closed Principle (OCP)

- **Applied:** Configuration is extensible without modifying upload logic
- **How:** Adding serverActions config doesn't require changes to upload.ts
- **Benefit:** Upload logic remains closed to modification

#### Interface Segregation Principle (ISP)

- **Applied:** Not directly applicable (configuration change, not interface design)
- **Note:** Existing upload interfaces remain focused and minimal

#### Dependency Inversion Principle (DIP)

- **Applied:** Upload action depends on framework abstraction (Server Actions), not concrete implementation
- **How:** Configuration adjusts framework behavior without changing action code
- **Benefit:** Upload logic is decoupled from framework limits

#### Liskov Substitution Principle (LSP)

- **Applied:** Not directly applicable (no inheritance or substitution involved)

### Potential Risks and Mitigation Strategies

#### Risk 1: Larger Memory Consumption

**Impact:** Low
**Mitigation:**

- 10MB is reasonable for image uploads in modern hosting environments
- Vercel (deployment target) handles this payload size without issue
- Admin-only feature (limited concurrent users)
- Session authentication limits attack surface

#### Risk 2: Slower Upload Times

**Impact:** Low
**Mitigation:**

- Expected behavior for larger files
- Progress indicator already implemented in ImageUploader
- Admin users expect longer uploads for high-quality images

#### Risk 3: DDoS Attack Vector

**Impact:** Low
**Mitigation:**

- Admin-only route (protected by proxy.ts)
- Session-based authentication required
- Supabase storage has its own limits
- Vercel has request timeout limits (10 seconds for Hobby, 60 seconds for Pro)

---

## Implementation Steps

### Step 1: Create Feature Branch

**Action:** Create a new Git branch for this issue

```bash
git checkout -b issue-35
```

**Dependencies:** None
**SOLID Principles:** N/A (Git workflow)

---

### Step 2: Add serverActions Configuration (TDD Red Phase)

**Action:** Write a test FIRST to verify the configuration exists

**Test File:** `__tests__/config/next.config.test.ts` (new file)

**Test Cases:**

1. Verify `experimental.serverActions.bodySizeLimit` is defined
2. Verify the limit is set to '10mb'
3. Verify the configuration object is valid TypeScript

**Implementation:**

```typescript
import { describe, it, expect } from 'vitest';
import nextConfig from '@/../../next.config';

describe('Next.js Configuration', () => {
    describe('Server Actions', () => {
        it('should have serverActions bodySizeLimit configured', () => {
            expect(nextConfig.experimental?.serverActions).toBeDefined();
            expect(
                nextConfig.experimental?.serverActions?.bodySizeLimit
            ).toBeDefined();
        });

        it('should set bodySizeLimit to 10mb', () => {
            expect(nextConfig.experimental?.serverActions?.bodySizeLimit).toBe(
                '10mb'
            );
        });
    });
});
```

**Expected Result:** Test should FAIL (Red phase) because configuration doesn't exist yet

**Verification Process:**

```bash
# TypeScript compile check
tsc --noEmit

# Vitest (should fail - Red phase)
npx vitest related run __tests__/config/next.config.test.ts
```

**Dependencies:** None
**SOLID Principles:**

- **SRP:** Test file responsible only for config verification
- **OCP:** Test is open to extension (can add more config checks)

---

### Step 3: Implement serverActions Configuration (TDD Green Phase)

**Action:** Add the configuration to make tests pass

**File:** `next.config.ts`

**Changes:**

```typescript
const nextConfig: NextConfig = {
    // ... existing configuration ...

    /**
     * Server Actions Configuration
     *
     * Increase body size limit to 10MB to support large image uploads.
     * Default is 1MB, which is too restrictive for high-quality artwork images.
     *
     * See: https://nextjs.org/docs/app/api-reference/next-config-js/serverActions#bodysizelimit
     */
    experimental: {
        serverActions: {
            bodySizeLimit: '10mb',
        },
        optimizePackageImports: [
            '@stripe/react-stripe-js',
            '@stripe/stripe-js',
            '@supabase/supabase-js',
            '@supabase/ssr',
            'date-fns',
        ],
    },

    // ... rest of configuration ...
};
```

**Expected Result:** Test should PASS (Green phase)

**Verification Process:**

```bash
# TypeScript compile check
tsc --noEmit

# ESLint check
npx eslint --fix next.config.ts

# Prettier formatting
npx prettier --write next.config.ts

# Run new test (should pass - Green phase)
npx vitest related run __tests__/config/next.config.test.ts

# Run all tests to verify no regressions
npm test
```

**If Verification Fails:**

1. Check error message and fix specific issue
2. Re-run verification commands
3. After 3 failed attempts, stop and request human guidance

**Dependencies:** Step 2 (test written first)
**SOLID Principles:**

- **SRP:** Configuration file contains only framework settings
- **OCP:** Adding config doesn't modify existing upload logic

---

### Step 4: Refactor Documentation (TDD Refactor Phase)

**Action:** Improve inline documentation while keeping tests green

**File:** `next.config.ts`

**Refactoring Opportunities:**

1. Add comment explaining why 10MB was chosen
2. Link to GitHub issue #35 for context
3. Ensure comment format matches existing patterns

**Updated Comment:**

```typescript
/**
 * Server Actions Configuration
 *
 * Body Size Limit: Increased to 10MB to support large image uploads.
 *
 * Why 10MB?
 * - Application validates up to 10MB in upload.ts (MAX_FILE_SIZE)
 * - Client-side validation enforces 10MB in ImageUploader.tsx
 * - Tests verify 10MB limit enforcement
 * - Supports high-quality artwork images for gallery/shop
 *
 * Default is 1MB, which is too restrictive for this use case.
 *
 * See: https://nextjs.org/docs/app/api-reference/next-config-js/serverActions#bodysizelimit
 * Related: GitHub Issue #35
 */
```

**Verification Process:**

```bash
# Prettier formatting (ensure comment formatting is correct)
npx prettier --write next.config.ts

# Run all tests (must still pass after refactor)
npm test

# TypeScript compile check
tsc --noEmit
```

**Dependencies:** Step 3 (implementation complete)
**SOLID Principles:**

- **OCP:** Documentation improved without modifying behavior

---

### Step 5: Manual Testing

**Action:** Verify large image uploads work in development environment

**Test Scenarios:**

1. **Test: Upload 2MB Image**
    - Navigate to `/admin/artwork/new`
    - Select a 2MB JPEG image
    - Click "Upload Image"
    - **Expected:** Upload succeeds, URLs returned

2. **Test: Upload 5MB Image**
    - Navigate to `/admin/artwork/new`
    - Select a 5MB PNG image
    - Click "Upload Image"
    - **Expected:** Upload succeeds, URLs returned

3. **Test: Upload 10MB Image (Boundary)**
    - Navigate to `/admin/artwork/new`
    - Select a 10MB JPEG image
    - Click "Upload Image"
    - **Expected:** Upload succeeds, URLs returned

4. **Test: Upload 11MB Image (Over Limit)**
    - Navigate to `/admin/artwork/new`
    - Select an 11MB image
    - Click "Upload Image"
    - **Expected:** Client-side validation rejects with "File too large. Maximum size is 10MB."

5. **Test: Verify Error Handling Still Works**
    - Navigate to `/admin/artwork/new`
    - Select a .txt file
    - **Expected:** Client-side validation rejects with "Invalid file type"

**Manual Testing Setup:**

```bash
# Start development server
npm run dev

# In separate terminal, ensure local Supabase is running
npm run db:start
```

**Dependencies:** Step 4 (refactoring complete)
**SOLID Principles:** N/A (manual testing)

---

### Step 6: Run Full Verification Suite

**Action:** Execute all code quality checks before requesting review

**Verification Commands:**

```bash
# 1. TypeScript compile check
tsc --noEmit

# 2. Lint entire codebase
npm run lint

# 3. Format entire codebase
npm run format

# 4. Run all tests with coverage
npm test

# 5. Build production bundle (verify no build errors)
npm run build
```

**Expected Results:**

- ✅ TypeScript: No errors
- ✅ ESLint: No errors or warnings
- ✅ Prettier: All files formatted
- ✅ Tests: All passing (including new config test)
- ✅ Build: Successful production build

**If Any Check Fails:**

1. Fix the specific error
2. Re-run the failed check
3. After 3 failed attempts on same error, stop and request human guidance

**Dependencies:** Step 5 (manual testing complete)
**SOLID Principles:** N/A (verification process)

---

### Step 7: Request Human Review

**Action:** Ask for review of all changes before creating PR

**Review Checklist:**

- [ ] Configuration change is minimal and focused
- [ ] Tests verify the configuration exists and is correct
- [ ] Documentation clearly explains the change
- [ ] Manual testing confirms uploads work for 2MB, 5MB, 10MB
- [ ] Manual testing confirms 11MB files are still rejected
- [ ] All automated tests pass
- [ ] Build succeeds

**Human Review Questions:**

1. Does 10MB feel like the right limit, or should we use a different value?
2. Should we add any additional logging for large uploads?
3. Is the documentation clear and sufficient?

**Dependencies:** Step 6 (all verifications pass)
**SOLID Principles:** N/A (human process)

---

### Step 8: Create Pull Request

**Action:** Create PR with descriptive title and body

**PR Title:**

```
fix: Increase Server Action body size limit to 10MB for image uploads (#35)
```

**PR Body:**

```markdown
## Summary

Fixes #35

Increases Next.js Server Action body size limit from 1MB (default) to 10MB to support large image uploads in the admin interface.

## Changes

- Added `experimental.serverActions.bodySizeLimit: '10mb'` to `next.config.ts`
- Added test to verify configuration is set correctly

## Why 10MB?

- Application already validates up to 10MB in `upload.ts` (MAX_FILE_SIZE constant)
- Client validates 10MB in `ImageUploader.tsx` (DEFAULT_MAX_SIZE_MB constant)
- Existing tests verify 10MB limit enforcement
- Supports high-quality artwork images for gallery/shop

## Testing

- ✅ New test verifies configuration is set to '10mb'
- ✅ All existing tests pass
- ✅ Manual testing: 2MB, 5MB, 10MB images upload successfully
- ✅ Manual testing: 11MB images correctly rejected by validation
- ✅ Build succeeds

## Security Considerations

- Limit increased from 1MB to 10MB (reasonable for image uploads)
- Admin-only feature (protected by proxy.ts authentication)
- Session-based authentication required
- Vercel hosting handles this payload size without issue

## Documentation

- Added inline comments explaining the configuration
- Linked to Next.js official documentation
- Referenced GitHub issue #35
```

**GitHub CLI Command:**

```bash
gh pr create \
  --title "fix: Increase Server Action body size limit to 10MB for image uploads (#35)" \
  --body-file .specs/pr-body-issue-35.md \
  --base main
```

**Dependencies:** Step 7 (human review complete and approved)
**SOLID Principles:** N/A (GitHub process)

---

### Step 9: After PR Approval, Squash and Merge

**Action:** Merge PR using squash merge strategy

**Merge Commit Message:**

```
fix: Increase Server Action body size limit to 10MB for image uploads (#35)

- Add experimental.serverActions.bodySizeLimit config to next.config.ts
- Set limit to '10mb' to match application validation logic
- Add test to verify configuration

Fixes #35
```

**GitHub CLI Command:**

```bash
gh pr merge --squash --delete-branch
```

**Post-Merge Actions:**

1. Verify issue #35 automatically closed
2. Update local main branch: `git checkout main && git pull`
3. Verify production deployment succeeds on Vercel

**Dependencies:** Step 8 (PR created and approved)
**SOLID Principles:** N/A (GitHub process)

---

## Verification Process

After **EACH** implementation step (Steps 2-6), follow this verification procedure:

### Verification Commands

```bash
# 1. TypeScript compile check (all steps)
tsc --noEmit

# 2. ESLint (for modified files)
npx eslint --fix next.config.ts __tests__/config/next.config.test.ts

# 3. Prettier (for modified files)
npx prettier --write next.config.ts __tests__/config/next.config.test.ts

# 4. Vitest (for related tests)
npx vitest related run next.config.ts
```

### Verification Steps

1. **Identify Modified Files:**
    - Step 2: `__tests__/config/next.config.test.ts`
    - Step 3: `next.config.ts`, `__tests__/config/next.config.test.ts`
    - Step 4: `next.config.ts`

2. **Run Verification Commands:**
    - Replace `{files}` with space-separated file paths from step 1
    - Run all four commands in sequence

3. **Handle Failures:**
    - If any command fails, fix the specific error
    - Retry the verification step
    - **3-Attempt Limit:** If failures persist beyond 3 attempts:
        - Stop implementation
        - Document the issue with:
            - Error message
            - Steps taken to resolve
            - Current state of code
        - Request human guidance

4. **Success Criteria:**
    - All verification commands pass
    - No TypeScript errors
    - No ESLint warnings
    - Code properly formatted
    - Related tests pass

5. **Proceed to Next Step:**
    - Only move forward when ALL verifications pass
    - This prevents accumulation of technical debt

---

## Testing Strategy

### Test-Driven Development Approach

This implementation follows strict TDD:

1. **Red Phase (Step 2):** Write test FIRST that fails
    - Test verifies configuration doesn't exist yet
    - Confirms test framework is working correctly

2. **Green Phase (Step 3):** Write minimal code to pass test
    - Add only the configuration required
    - Test should now pass

3. **Refactor Phase (Step 4):** Improve code while tests stay green
    - Enhance documentation
    - Verify tests still pass after changes

### Unit Tests (Written FIRST)

**Test File:** `__tests__/config/next.config.test.ts` (new)

**Test Cases:**

1. ✅ Verify `experimental.serverActions` exists
2. ✅ Verify `bodySizeLimit` is defined
3. ✅ Verify `bodySizeLimit` equals '10mb'

### Integration Tests (Existing - No Changes)

**Test File:** `__tests__/app/admin/actions/upload.test.ts`

**Test Cases (Already Exist):**

1. ✅ Files larger than 10MB are rejected (line 222-234)
2. ✅ JPEG files are accepted (line 134-176)
3. ✅ PNG files are accepted (line 178-220)
4. ✅ All 3 image variants upload successfully (line 300-322)

### Manual Testing Scenarios

**Scenario 1: Upload 2MB Image**

- **Goal:** Verify no longer blocked by 1MB framework limit
- **Expected:** Upload succeeds

**Scenario 2: Upload 5MB Image**

- **Goal:** Verify mid-range uploads work
- **Expected:** Upload succeeds

**Scenario 3: Upload 10MB Image (Boundary)**

- **Goal:** Verify maximum allowed size works
- **Expected:** Upload succeeds

**Scenario 4: Upload 11MB Image (Over Limit)**

- **Goal:** Verify application validation still enforces 10MB limit
- **Expected:** Client validation rejects with error message

**Scenario 5: Upload .txt File**

- **Goal:** Verify type validation unchanged
- **Expected:** Client validation rejects with error message

### Test Coverage Goals

**Coverage Goals:**

- New config test file: 100% (3 assertions, all critical)
- Existing upload action tests: Maintain current coverage (already comprehensive)
- No decrease in overall test coverage

**Coverage Command:**

```bash
npm run test:coverage
```

### Regression Tests

**Regression Prevention:**

- All existing tests must pass (no changes to upload logic)
- Manual testing verifies existing workflows unaffected
- Build process must succeed without warnings

---

## Considerations

### Security Implications

**Risk:** Larger payloads increase potential for abuse
**Mitigation:**

- Admin-only feature (protected by `proxy.ts`)
- Session-based authentication with 15-minute cache
- Supabase Storage has built-in upload limits
- Vercel has request timeout protection
- 10MB is reasonable for image uploads in 2025

**Assessment:** Low risk. Security posture unchanged.

### Performance Impacts

**Memory Usage:**

- Larger payloads consume more memory during upload
- 10MB is well within Node.js/Vercel memory limits
- Temporary impact only during upload (not persisted)

**Upload Time:**

- Larger files take longer to upload
- Progress indicator already implemented
- Expected behavior for high-quality images

**Assessment:** Low impact. Performance trade-off acceptable for admin feature.

### Database Migrations

**Required:** None
**Rationale:** Configuration-only change, no schema modifications

### Backward Compatibility

**Breaking Changes:** None
**Rationale:**

- Increasing limit is backward compatible (smaller uploads still work)
- No API changes
- No changes to existing upload validation logic

**Compatibility Assessment:** Fully backward compatible

### Documentation Updates Needed

**Files to Update:**

1. **CLAUDE.md** (Optional)
    - Consider adding note about Server Action limits
    - Location: "Configuration Management" section

2. **Inline Comments** (Required)
    - Already included in Step 4 (refactoring)
    - Clear explanation of why 10MB was chosen

**Assessment:** Inline comments sufficient. CLAUDE.md update optional.

---

## Summary

This implementation plan addresses GitHub Issue #35 by configuring Next.js to accept Server Action payloads up to 10MB, matching the application's existing validation logic.

### Key Points

✅ **Simple Configuration Change:** One line added to `next.config.ts`
✅ **Test-Driven Development:** Test written FIRST, then implementation
✅ **SOLID Principles:** SRP, OCP, DIP applied appropriately
✅ **Comprehensive Testing:** Unit tests + manual testing + regression tests
✅ **Low Risk:** Admin-only feature, no breaking changes
✅ **Well Documented:** Inline comments explain the decision

### Complexity Justification

**Low Complexity:**

- Single file modification (plus one test file)
- No business logic changes
- No database changes
- No UI changes
- Clear, straightforward solution

### Next Steps

Please review this plan and provide feedback. I will not proceed with implementation until you give explicit approval.

**Questions for Review:**

1. Is 10MB the right limit, or should it be different?
2. Should we add any monitoring/logging for large uploads?
3. Does the testing strategy feel comprehensive?
4. Any concerns about security or performance?

---

**Plan Status:** ⏸️ Awaiting Human Approval
