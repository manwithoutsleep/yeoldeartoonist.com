# Implementation Plan: Show Image Thumbnail After Upload on Artwork Admin Page

**Issue:** #28 - On the Add New Artwork page, show the image thumbnail after uploading

**Created:** 2025-11-27T12:22:06

---

## Overview

### Problem Statement

On the Artwork Admin page (`/admin/artwork/new`), when a user selects an image, they see a preview. However, after clicking "Upload Image", the preview disappears and no thumbnail is shown. This differs from the Projects and Events admin pages, where thumbnails remain visible after upload.

### Root Cause Analysis

After examining the codebase, I identified the following architectural difference:

**ArtworkForm.tsx** (lines 50-58):

- Uses a state object `imageUrls` containing `image_thumbnail_url`, `image_url`, and `image_large_url`
- Passes `existingImageUrl={initialData?.image_url || undefined}` to ImageUploader
- Does NOT update with newly uploaded URLs for display purposes

**ProjectForm.tsx** (lines 25-27) and **EventForm.tsx** (lines 22-24):

- Use a simple `imageUrl` state variable
- Pass `existingImageUrl={imageUrl}` to ImageUploader
- The `setImageUrl` callback updates the state, which is then passed back to ImageUploader as `existingImageUrl`

**ImageUploader.tsx** (lines 136, 167-182):

- Clears preview (`handleClear()`) after successful upload (line 136)
- Shows `existingImageUrl` when no preview is active (lines 167-182)
- Since ArtworkForm doesn't update `existingImageUrl` prop with newly uploaded URLs, no thumbnail appears

### Success Criteria

- After uploading an image on the Artwork admin page, the thumbnail should be visible
- Behavior should match Projects and Events admin pages
- All existing tests should continue to pass
- New behavior should be covered by tests

### Estimated Scope

**Complexity:** Low

This is a straightforward state management fix requiring minimal code changes to align ArtworkForm's behavior with ProjectForm and EventForm patterns.

---

## Technical Approach

### Architectural Decisions

#### 1. State Management Pattern Alignment

**Decision:** Modify `ArtworkForm.tsx` to pass uploaded URL back to `ImageUploader` as `existingImageUrl`

**Rationale:**

- **Single Responsibility Principle (SRP):** ImageUploader is responsible for displaying images (both preview and uploaded). ArtworkForm should only manage form state and pass appropriate props.
- **Open/Closed Principle:** No changes needed to ImageUploader component; the fix extends ArtworkForm's behavior without modifying the reusable component.
- **Consistency:** Aligns with established pattern in ProjectForm and EventForm, reducing cognitive overhead for future maintainers.

#### 2. Minimal Change Approach

**Decision:** Only modify the `existingImageUrl` prop passed to ImageUploader

**Rationale:**

- The existing `imageUrls` state structure is correct for form submission (all three URL variants are needed)
- The issue is purely presentational (thumbnail display)
- **Dependency Inversion Principle:** ImageUploader depends on the abstraction of `existingImageUrl` prop, not on how parent components manage their state

### Design Patterns

- **Controlled Component Pattern:** ImageUploader remains a controlled component with parent managing state
- **Callback Props Pattern:** `onUploadComplete` callback successfully updates parent state; we just need to reflect that update back to the child

### Integration Points

- `ArtworkForm.tsx` (line 129): Update `existingImageUrl` prop
- No changes to `ImageUploader.tsx`, `ProjectForm.tsx`, or `EventForm.tsx`

### Potential Risks and Mitigation

1. **Risk:** Breaking existing artwork creation/editing functionality
    - **Mitigation:** Follow TDD approach - write test first to verify thumbnail display, ensure all existing tests pass

2. **Risk:** Inconsistent behavior between create and edit modes
    - **Mitigation:** Test both scenarios (new artwork with no existing image, editing artwork with existing image)

---

## Implementation Steps

### Step 1: Create Feature Branch

**Action:**

```bash
git checkout -b issue-28
```

**TDD Phase:** N/A (setup step)

**SOLID Principles:** N/A

**Verification:**

```bash
git branch
```

Expected: `* issue-28` shown as current branch

---

### Step 2: Write Failing Test for Thumbnail Display After Upload

**Action:** Create a test that verifies the thumbnail is visible after upload in ArtworkForm

**TDD Phase:** ðŸ”´ RED (Write failing test)

**Test File:** `__tests__/components/admin/artwork/ArtworkForm.test.tsx`

**Test Case to Add:**

```typescript
it('should display uploaded image thumbnail after successful upload', async () => {
    const { uploadImageAction } = await import('@/app/admin/actions/upload');
    (uploadImageAction as ReturnType<typeof vi.fn>).mockResolvedValue({
        success: true,
        data: {
            image_thumbnail_url: 'https://example.com/thumb.webp',
            image_url: 'https://example.com/preview.webp',
            image_large_url: 'https://example.com/large.webp',
        },
    });

    render(<ArtworkForm />);

    // Upload an image
    const file = new File(['image content'], 'test-artwork.jpg', {
        type: 'image/jpeg',
    });
    const fileInput = screen.getByLabelText(/choose image file/i);
    fireEvent.change(fileInput, { target: { files: [file] } });

    const uploadButton = await screen.findByRole('button', {
        name: /upload image/i,
    });
    fireEvent.click(uploadButton);

    // Verify thumbnail is displayed after upload
    await waitFor(() => {
        const currentImage = screen.getByAltText(/current image/i);
        expect(currentImage).toBeInTheDocument();
        expect(currentImage).toHaveAttribute('src', 'https://example.com/preview.webp');
    });
});
```

**Why (Rationale):**

- Reproduces the user-reported issue: preview disappears, no thumbnail shown
- Establishes expected behavior: thumbnail should use the uploaded `image_url`
- Provides regression protection for the fix

**SOLID Principles:**

- Test validates **Single Responsibility** of ImageUploader (display) and ArtworkForm (state management)

**Verification:**

```bash
npx vitest related run __tests__/components/admin/artwork/ArtworkForm.test.tsx
```

Expected: Test fails because thumbnail is not currently displayed after upload

---

### Step 3: Modify ArtworkForm to Pass Uploaded Image URL to ImageUploader

**Action:** Update `existingImageUrl` prop to use `imageUrls.image_url`

**TDD Phase:** ðŸŸ¢ GREEN (Make test pass with minimal code)

**File:** `src/components/admin/artwork/ArtworkForm.tsx`

**Changes:**

```typescript
// Line 129: Update existingImageUrl prop
<ImageUploader
    onUploadComplete={(urls) => setImageUrls(urls)}
    existingImageUrl={imageUrls.image_url || initialData?.image_url || undefined}
    maxSizeMB={10}
/>
```

**Why (Rationale):**

- After upload, `imageUrls.image_url` contains the newly uploaded URL
- Falls back to `initialData?.image_url` for edit mode (existing artwork)
- This makes the uploaded image available to ImageUploader as `existingImageUrl`
- ImageUploader's existing logic (lines 167-182) will display it when preview is cleared

**SOLID Principles:**

- **Single Responsibility:** ArtworkForm manages state, ImageUploader displays images
- **Open/Closed:** Extended ArtworkForm's behavior without modifying ImageUploader
- **Dependency Inversion:** ArtworkForm depends on ImageUploader's `existingImageUrl` abstraction

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/components/admin/artwork/ArtworkForm.tsx
npx prettier --write src/components/admin/artwork/ArtworkForm.tsx
npx vitest related run src/components/admin/artwork/ArtworkForm.tsx
```

Expected: All verifications pass, new test passes

**Retry on Failure:** If any verification fails, fix the specific error and retry. After 3 attempts, stop and request human guidance.

---

### Step 4: Refactor for Consistency and Clarity

**Action:** Review code for any refactoring opportunities while keeping tests passing

**TDD Phase:** ðŸ”µ REFACTOR (Improve code quality while tests pass)

**Potential Refactoring:**

- Extract `imageUrls.image_url || initialData?.image_url || undefined` logic to a computed value if it improves readability
- Add code comments if the fallback chain is not self-evident

**Decision Point:** Only refactor if clarity is improved. The current change is minimal and clear.

**Why (Rationale):**

- The current implementation is already clean and follows established patterns
- The fallback chain is self-documenting (uploaded URL â†’ initial data URL â†’ undefined)
- No refactoring needed unless complexity increases

**SOLID Principles:**

- Refactoring ensures **Open/Closed Principle** (code is easy to extend later)

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/components/admin/artwork/ArtworkForm.tsx
npx prettier --write src/components/admin/artwork/ArtworkForm.tsx
npx vitest related run src/components/admin/artwork/ArtworkForm.tsx
```

Expected: All verifications pass, tests still pass after refactoring

**Retry on Failure:** If verifications fail, revert refactoring and retry. After 3 attempts, stop and request guidance.

---

### Step 5: Run Full Test Suite

**Action:** Verify all existing tests still pass

**TDD Phase:** Verification (ensure no regressions)

**Why (Rationale):**

- Ensures change doesn't break existing functionality
- Validates integration with ImageUploader component
- Confirms behavior consistency across all admin forms

**SOLID Principles:**

- Validates **Liskov Substitution Principle** (ArtworkForm still behaves as expected in all contexts)

**Verification:**

```bash
npm test
```

Expected: All tests pass with no regressions

**Retry on Failure:** If tests fail, analyze failure, fix issue, and rerun. After 3 attempts, stop and request guidance.

---

### Step 6: Manual Testing

**Action:** Test the fix in development environment

**Test Scenarios:**

1. **Create New Artwork with Image Upload**
    - Navigate to `/admin/artwork/new`
    - Select an image file
    - Verify preview is shown
    - Click "Upload Image"
    - **Expected:** Thumbnail appears after upload completes
    - Fill in artwork details and save
    - Verify artwork is created with correct image URLs

2. **Edit Existing Artwork with Image**
    - Navigate to `/admin/artwork` and select an artwork with an image
    - **Expected:** Existing thumbnail is shown initially
    - Select a new image
    - **Expected:** Preview is shown
    - Click "Upload Image"
    - **Expected:** New thumbnail replaces old one
    - Save changes
    - Verify artwork is updated with new image URLs

3. **Edit Existing Artwork, Change Image Multiple Times**
    - Navigate to existing artwork
    - Upload new image
    - **Expected:** Thumbnail shown
    - Upload another new image
    - **Expected:** Thumbnail updates to newest upload
    - Save and verify

4. **Comparison Test: Verify Consistency Across Admin Pages**
    - Upload image on `/admin/artwork/new`
    - Upload image on `/admin/projects/new`
    - Upload image on `/admin/events/new`
    - **Expected:** All three pages show thumbnails after upload (consistent behavior)

**Why (Rationale):**

- UI/UX validation cannot be fully automated
- Ensures the fix matches user expectations from the issue description
- Validates behavior matches Projects and Events admin pages

**SOLID Principles:**

- Manual testing validates **Interface Segregation Principle** (user interface meets user needs without unnecessary complexity)

**Verification:**

```bash
npm run dev
```

Then manually test all scenarios in browser

**Retry on Failure:** If manual testing reveals issues, document them, create additional tests if needed, fix issues, and retest. After 3 attempts, stop and request guidance.

---

### Step 7: Request Human Review of All Local Changes

**Action:** Present changes for review before creating PR

**Review Checklist:**

- [ ] Code changes are minimal and focused
- [ ] Test coverage is adequate
- [ ] Manual testing scenarios passed
- [ ] No regressions in existing functionality
- [ ] Behavior matches Projects and Events admin pages
- [ ] Code follows SOLID principles
- [ ] TDD approach was followed

**Commands to Show Changes:**

```bash
git status
git diff src/components/admin/artwork/ArtworkForm.tsx
git diff __tests__/components/admin/artwork/ArtworkForm.test.tsx
```

**Why (Rationale):**

- Human review catches issues automated tests might miss
- Validates approach aligns with project goals
- Ensures code quality and maintainability

**Next Step:** Wait for approval before proceeding to PR creation

---

### Step 8: Create Pull Request

**Action:** Create PR for issue-28

**Prerequisites:**

- Human approval from Step 7
- All tests passing
- Manual testing completed successfully

**Commands:**

```bash
git add src/components/admin/artwork/ArtworkForm.tsx __tests__/components/admin/artwork/ArtworkForm.test.tsx
git commit -m "$(cat <<'EOF'
fix: Show image thumbnail after upload on Artwork admin page

Fixes #28

After uploading an image on the Artwork admin page, the thumbnail
is now displayed, matching the behavior of Projects and Events
admin pages.

Root cause: ArtworkForm was not passing the uploaded image URL
back to ImageUploader as existingImageUrl, so the component had
no URL to display after clearing the preview.

Solution: Updated existingImageUrl prop to use imageUrls.image_url
with fallback to initialData?.image_url for edit mode.

Changes:
- Updated ArtworkForm.tsx to pass uploaded URL to ImageUploader
- Added test coverage for thumbnail display after upload

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
git push -u origin issue-28
gh pr create --title "fix: Show image thumbnail after upload on Artwork admin page" --body "$(cat <<'EOF'
## Summary
Fixes #28

After uploading an image on the Artwork admin page (`/admin/artwork/new`), the thumbnail is now displayed, matching the behavior of Projects and Events admin pages.

## Root Cause
ArtworkForm was not passing the uploaded image URL back to ImageUploader as `existingImageUrl`. After upload, ImageUploader cleared the preview but had no URL to display as a thumbnail.

## Solution
Updated `existingImageUrl` prop in ArtworkForm to use `imageUrls.image_url` (newly uploaded) with fallback to `initialData?.image_url` (for edit mode).

## Changes
- `src/components/admin/artwork/ArtworkForm.tsx`: Updated `existingImageUrl` prop (1 line changed)
- `__tests__/components/admin/artwork/ArtworkForm.test.tsx`: Added test for thumbnail display after upload

## Testing
- âœ… New test: Verifies thumbnail is displayed after upload
- âœ… All existing tests pass (no regressions)
- âœ… Manual testing: Verified behavior matches Projects and Events admin pages

## Test Plan
- [x] Create new artwork with image upload - thumbnail shown after upload
- [x] Edit existing artwork with image replacement - thumbnail updates
- [x] Verify consistency with Projects and Events admin pages
- [x] All automated tests pass

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

**Why (Rationale):**

- Provides clear context for code reviewers
- Links to original issue for traceability
- Documents root cause and solution for future reference

**Verification:**

```bash
gh pr view --web
```

Expected: PR created and viewable in browser

---

### Step 9: After PR Approval, Squash and Merge

**Action:** Merge PR after approval

**Prerequisites:**

- PR approval from reviewer
- All CI checks passing

**Commands:**

```bash
gh pr merge --squash --delete-branch
```

**Why (Rationale):**

- Squash merge keeps main branch history clean (single commit for the fix)
- Automatic branch deletion keeps repository tidy

**Verification:**

```bash
git checkout main
git pull
git log --oneline -1
```

Expected: Latest commit on main is the squashed fix commit

---

## Verification Process

After **EACH** implementation step (Steps 2-5), follow this procedure:

### Verification Commands

```bash
# 1. TypeScript compile check (run for all steps)
tsc --noEmit

# 2. ESLint (run for modified files)
npx eslint --fix src/components/admin/artwork/ArtworkForm.tsx
npx eslint --fix __tests__/components/admin/artwork/ArtworkForm.test.tsx

# 3. Prettier (run for modified files)
npx prettier --write src/components/admin/artwork/ArtworkForm.tsx
npx prettier --write __tests__/components/admin/artwork/ArtworkForm.test.tsx

# 4. Vitest (run related tests)
npx vitest related run src/components/admin/artwork/ArtworkForm.tsx
```

### Verification Steps

1. Identify the specific file paths modified in the current step
2. Run all four verification commands in sequence
3. If any command fails:
    - Fix the specific error immediately
    - Retry the verification step
4. If failures persist beyond 3 attempts:
    - Stop implementation
    - Document the issue clearly
    - Request human guidance
5. Only proceed to next step when ALL verifications pass

### Why This Process Matters

- **Prevents Technical Debt:** Catches issues immediately rather than accumulating them
- **Maintains Code Quality:** Ensures consistent formatting, linting, and type safety
- **Test-Driven Safety:** Confirms tests pass after each change
- **Efficient Debugging:** Failures are isolated to the current step, making diagnosis easier

---

## Testing Strategy

### TDD Approach (Red-Green-Refactor)

#### Red Phase (Step 2)

- **Test Written FIRST:** Create failing test that verifies thumbnail display after upload
- **Goal:** Reproduce the user-reported issue in automated test form
- **Success Criteria:** Test fails as expected (no thumbnail currently shown)

#### Green Phase (Step 3)

- **Implementation:** Minimal code change to make test pass
- **Goal:** Fix the issue with simplest possible solution
- **Success Criteria:** New test passes, all existing tests pass

#### Refactor Phase (Step 4)

- **Improvement:** Clean up code while keeping tests green
- **Goal:** Ensure code quality, readability, and maintainability
- **Success Criteria:** All tests still pass, code is clear and follows SOLID principles

### Unit Tests

**File:** `__tests__/components/admin/artwork/ArtworkForm.test.tsx`

**New Test Cases:**

1. Thumbnail display after successful upload (primary test from Step 2)

**Test Coverage Goals:**

- High coverage of new behavior (thumbnail display after upload)
- No reduction in existing test coverage

### Integration Tests

**Manual Testing Scenarios (Step 6):**

- Create new artwork with image upload
- Edit existing artwork with image replacement
- Multiple image uploads on same form
- Cross-page consistency check (Artwork vs Projects vs Events)

### Regression Tests

- All existing ImageUploader tests continue to pass
- All existing ArtworkForm tests continue to pass
- No side effects on ProjectForm or EventForm

### Test Data Requirements

- Mock image files (JPEG, PNG formats)
- Mock upload API responses with all three URL variants
- Mock existing artwork data for edit mode testing

---

## Considerations

### Security Implications

- **None:** This change only affects UI display logic, not upload functionality or data handling
- Upload security is already handled by `ImageUploader` component and upload API
- No new attack vectors introduced

### Performance Impacts

- **None:** No additional re-renders or state updates
- Same data flow as Projects and Events forms (proven performant)
- No new API calls or expensive operations

### Database Migrations

- **None required:** No schema changes
- Image URLs are already stored in database
- Only presentational logic changed

### Backward Compatibility

- **Fully compatible:** No breaking changes to component interfaces
- Existing artwork records work without modification
- Edit mode continues to work with existing images

### Documentation Updates

- **None required:**
    - Change aligns behavior with existing patterns (Projects, Events)
    - No new features requiring user documentation
    - Code change is self-documenting (follows established pattern)

---

## SOLID Principles Application

### Single Responsibility Principle (SRP)

- **ArtworkForm:** Manages form state and submission (one responsibility)
- **ImageUploader:** Handles image display, upload UI, and validation (one responsibility)
- **Clear separation:** Form state in parent, display logic in child

### Open/Closed Principle

- **Open for Extension:** ArtworkForm extended its behavior (passing uploaded URL) without modifying ImageUploader
- **Closed for Modification:** No changes to ImageUploader component itself
- **Benefit:** Reusable ImageUploader component works across all admin forms

### Liskov Substitution Principle

- **Substitutability:** ArtworkForm can be used anywhere a form component is expected
- **Contract Preservation:** Component still accepts same props and behaves predictably
- **Tests Verify:** All existing tests pass, confirming substitutability maintained

### Interface Segregation Principle

- **Focused Interface:** ImageUploader accepts minimal props (`onUploadComplete`, `existingImageUrl`, `maxSizeMB`)
- **No Unused Props:** ArtworkForm only uses what it needs
- **User Interface:** Users get exactly what they need (thumbnail after upload) without unnecessary complexity

### Dependency Inversion Principle

- **Abstraction:** ArtworkForm depends on ImageUploader's prop interface (abstraction), not implementation details
- **Decoupling:** ImageUploader doesn't know about ArtworkForm's internal state structure
- **Flexibility:** Either component can be modified independently as long as interface is maintained

---

## Complexity Justification

**Complexity:** Low

**Justification:**

- Single prop change (1 line of code modified)
- No architectural changes required
- Follows existing established pattern from ProjectForm and EventForm
- Minimal testing required (one new test case)
- No database, API, or infrastructure changes
- No new dependencies or libraries
- Low risk of regressions (isolated change)

**Estimated Implementation Time:**

- Code changes: 5 minutes
- Test writing: 15 minutes
- Verification and testing: 20 minutes
- PR creation and documentation: 10 minutes
- **Total:** ~50 minutes of focused work

---

## Concerns

### None Identified

This is a straightforward fix with:

- Clear root cause
- Proven solution pattern (used in ProjectForm, EventForm)
- Minimal code changes
- Low risk of side effects
- Good test coverage

**Confidence Level:** High

The fix aligns ArtworkForm with the established pattern used successfully in other admin forms, making this a low-risk, high-confidence change.

---

## Next Steps

**Awaiting human approval to proceed with implementation.**

Please review this plan and provide feedback or approval. I will not make any code changes until you give explicit approval.

If you have questions about the approach or would like to discuss alternative solutions, I'm happy to revise the plan.
