# Implementation Plan: Issue #107 - Admin Email Notification for New Orders

**Issue**: #107
**Title**: When a shopper places an order, notify the site admin
**Created**: 2026-01-18T17-34-44
**Status**: Planning

## Overview

This issue requests admin email notification functionality when shoppers place orders on the site. Currently, the site admin receives no notification when purchases occur, making it difficult to fulfill orders in a timely manner.

### Goals and Success Criteria

1. Site admin (`joe@yeoldeartoonist.com`) receives an email notification when an order is placed
2. Email notification contains sufficient detail for the admin to process the order
3. Implementation uses the existing `AdminNotification.tsx` template that is currently unused
4. Notification is sent automatically as part of the order creation workflow
5. Email failures do not block order creation

### Estimated Scope and Complexity

**Complexity**: Low

**Rationale**:

- The `sendAdminNotificationEmail()` function already exists in `src/lib/email/send.ts`
- The `AdminNotification.tsx` template is already complete and tested
- The webhook handler already calls `sendOrderEmails()` which includes admin notification
- The admin email address already exists in `siteConfig.artist.email`
- This is primarily a refactoring and configuration task, not new development

## Current State Analysis

### Existing Infrastructure

1. **Email Service** (`src/lib/email/send.ts:143-221`):
    - `sendAdminNotificationEmail(order: Order)` function exists and is fully implemented
    - Currently uses `ADMIN_EMAIL` environment variable (will be refactored to use `siteConfig.artist.email`)
    - Returns `EmailResult` with success/error status
    - Logs errors but does not throw (non-blocking)

2. **Email Template** (`src/lib/email/templates/AdminNotification.tsx`):
    - Complete React Email component for admin notifications
    - Displays order summary, customer info, items, shipping address, and notes
    - Includes link to admin dashboard order detail page
    - Professional styling with emoji header "ðŸŽ¨ New Order Received"
    - Fully tested with comprehensive test coverage

3. **Order Emails Function** (`src/lib/email/send.ts:232-263`):
    - `sendOrderEmails(order: Order)` sends both customer and admin emails in parallel
    - Already called from webhook handler after order creation
    - Returns results for both emails

4. **Webhook Integration** (`src/app/api/checkout/webhook/route.ts:277`):
    - Webhook handler already calls `sendOrderEmails(order)` after creating an order
    - Logs errors for failed email sends
    - Email failures don't block order creation (non-blocking design)

5. **Site Configuration** (`src/config/site.ts:10`):
    - `siteConfig.artist.email` already contains `joe@yeoldeartoonist.com`
    - Email configuration will be centralized here instead of environment variables

6. **Test Coverage** (`__tests__/lib/email/send.test.ts:369-555`):
    - Comprehensive tests for `sendAdminNotificationEmail()`
    - Template rendering tests for `AdminNotification`
    - Error handling tests (missing API key, missing admin email)
    - All tests passing

### Problem Diagnosis

**Based on the code analysis, the admin notification functionality is ALREADY FULLY IMPLEMENTED.** The issue is likely one of the following:

1. **Configuration Architecture**: Email config uses environment variables instead of centralized `siteConfig`
2. **Configuration Issue**: `ADMIN_EMAIL` environment variable may not be set in production
3. **Email Delivery Issue**: Emails may be sent but not delivered (spam filter, DNS, Resend configuration)
4. **Silent Failure**: Email sending may be failing silently without proper alerting

The most likely scenario is that `ADMIN_EMAIL` is not configured in the production environment, causing the function to return early with a warning (see `send.ts:149-161`). Additionally, email configuration should be moved from environment variables to `siteConfig` for better maintainability and type safety.

## Technical Approach

### Architectural Decisions and Rationale

**Decision 1**: Move email configuration from environment variables to `siteConfig`
**Rationale**:

- Email addresses (`joe@yeoldeartoonist.com`, `orders@yeoldeartoonist.com`) are not secrets
- `siteConfig.artist.email` already contains the admin email - eliminates duplication
- TypeScript type safety and autocomplete for configuration
- Centralized configuration in one predictable location
- Simpler deployment (one less environment variable to configure)
- Only `RESEND_API_KEY` remains as environment variable (actual secret)

**Decision 2**: Verify existing implementation rather than building new functionality
**Rationale**: All code is already in place and tested. The issue is likely environmental configuration or email delivery, not missing functionality.

**Decision 3**: Add monitoring and validation for email configuration
**Rationale**: The current implementation logs warnings but doesn't alert operators. We should add explicit startup validation and better error visibility.

**Decision 4**: Create test script to verify email functionality
**Rationale**: A test script allows the site admin to verify email delivery without waiting for an actual order.

**Decision 5**: Add documentation for email configuration troubleshooting
**Rationale**: Helps operators diagnose and fix email delivery issues independently.

### SOLID Principles Application

**Single Responsibility Principle (SRP)**:

- Each email function has one job: `sendAdminNotificationEmail()` sends admin emails, `sendOrderConfirmationEmail()` sends customer emails
- Test scripts will have single responsibility: verify email configuration or send test emails

**Open/Closed Principle (OCP)**:

- Email service is extensible through new email template types without modifying existing functions
- Configuration validation can be extended without changing email sending logic

**Liskov Substitution Principle (LSP)**:

- All email sending functions return the same `EmailResult` type
- Any email function can be substituted where `EmailResult` is expected

**Interface Segregation Principle (ISP)**:

- Email functions accept only what they need (`Order` or `ContactFormData`)
- Test scripts will use the same focused interfaces

**Dependency Inversion Principle (DIP)**:

- Email service depends on `EmailResult` abstraction, not concrete implementations
- Resend client is injected via environment configuration
- Test scripts will depend on the same abstractions

### Design Patterns to Be Used

1. **Factory Pattern**: Environment-based configuration creation
2. **Template Method Pattern**: React Email templates follow consistent structure
3. **Strategy Pattern**: Different email types use different templates but same sending mechanism

### Integration Points

1. **Webhook Handler** (`src/app/api/checkout/webhook/route.ts:277`): Already integrated
2. **Environment Variables** (`.env.local`, `.env.production`): Need validation
3. **Resend API**: Need to verify configuration and deliverability

### Potential Risks and Mitigation Strategies

**Risk 1**: Email is configured but going to spam
**Mitigation**:

- Verify Resend domain DNS records (SPF, DKIM, DMARC)
- Check spam folders
- Test with multiple email providers (Gmail, Outlook, etc.)
- Document email deliverability setup in `.docs/`

**Risk 2**: Environment variable not set in production
**Mitigation**:

- Add startup validation script
- Document required environment variables
- Create deployment checklist

**Risk 3**: Silent failures masking real issues
**Mitigation**:

- Add explicit logging for email configuration on startup
- Create admin test endpoint to verify email sending
- Add email status to admin dashboard

## Implementation Steps

### Step 1: Create branch

```bash
git checkout -b issue-107
```

**TDD Cycle**: Not applicable (setup step)

**Verification**: Not applicable (setup step)

**SOLID Principles**: Not applicable (setup step)

---

### Step 2: Add email configuration to site.ts

**What**: Update `src/config/site.ts` to include email configuration section

**Why**: Centralizes non-secret email configuration with type safety instead of environment variables

**Implementation**:

- Add `email` section to `siteConfig` with:
    - `fromAddress: 'orders@yeoldeartoonist.com'`
    - `fromName: 'Ye Olde Artoonist'`
- Admin email will use existing `artist.email` field
- Export type-safe configuration

**SOLID Principles**:

- **SRP**: Site config has single responsibility - centralize site configuration
- **OCP**: Extensible for additional email settings without changing structure

**TDD Cycle**: Not applicable (configuration file)

**Verification Process**:

1. Files modified: `src/config/site.ts`
2. Run verification commands:
    - `tsc --noEmit`
    - `npx eslint --fix src/config/site.ts`
    - `npx prettier --write src/config/site.ts`
3. Verify no compilation errors
4. If failures persist beyond 3 attempts, stop and ask for human guidance

---

### Step 3: Update .env.example to remove email configuration

**What**: Remove `EMAIL_FROM_ADDRESS`, `EMAIL_FROM_NAME`, and `ADMIN_EMAIL` from `.env.example`

**Why**: These values are no longer environment variables - they're in `siteConfig` now

**Implementation**:

- Remove the three email environment variables
- Keep `RESEND_API_KEY` (the actual secret)
- Add comment explaining email config is in `src/config/site.ts`

**SOLID Principles**: Not applicable (environment file)

**TDD Cycle**: Not applicable (environment file)

**Verification Process**:

1. Files modified: `.env.example`
2. Run verification commands:
    - `npx prettier --write .env.example`
3. Manual review for correctness
4. If issues found, revise

---

### Step 4: Write tests for updated send.ts to use siteConfig (TDD Red)

**What**: Update existing tests in `__tests__/lib/email/send.test.ts` to work with siteConfig instead of environment variables

**Why**: Following TDD, we update tests first before refactoring send.ts to use siteConfig

**Test File**: `__tests__/lib/email/send.test.ts` (update existing)

**Test Updates**:

- Remove tests for `ADMIN_EMAIL` environment variable
- Remove tests for `EMAIL_FROM_ADDRESS` environment variable
- Keep tests for `RESEND_API_KEY` validation (still required)
- Update mocks to not set email env vars (they come from siteConfig now)
- Verify emails use `siteConfig.artist.email` as admin recipient
- Verify emails use `siteConfig.email.fromAddress` and `siteConfig.email.fromName`

**SOLID Principles**:

- **SRP**: Tests focus on email sending behavior
- **DIP**: Tests depend on siteConfig abstraction

**TDD Phase**: Red (tests will fail after changes - send.ts still uses env vars)

**Verification Process**:

1. After writing tests, run: `npx vitest related run __tests__/lib/email/send.test.ts`
2. Verify updated tests FAIL as expected (send.ts not yet refactored)
3. Verify we haven't broken other unrelated tests
4. If more than 3 attempts needed, escalate for human guidance

---

### Step 5: Refactor send.ts to use siteConfig (TDD Green)

**What**: Update `src/lib/email/send.ts` to use `siteConfig` instead of environment variables for email configuration

**Why**: Centralizes configuration, improves type safety, eliminates duplication with artist.email

**Implementation**:

- Import `siteConfig` from `@/config/site`
- Replace `process.env.EMAIL_FROM_ADDRESS` with `siteConfig.email.fromAddress`
- Replace `process.env.EMAIL_FROM_NAME` with `siteConfig.email.fromName`
- Replace `process.env.ADMIN_EMAIL` with `siteConfig.artist.email`
- Remove `ADMIN_EMAIL` validation (no longer needed - always available in siteConfig)
- Keep `RESEND_API_KEY` validation (still from environment)
- Update error messages to reflect new configuration source

**Dependencies**: Requires Step 4 (tests updated first), Step 2 (siteConfig.email exists)

**SOLID Principles**:

- **SRP**: Email sending maintains single responsibility
- **DIP**: Depends on siteConfig abstraction, not environment
- **OCP**: Configuration source changed without modifying email sending logic

**TDD Phase**: Green (implement changes to make tests pass)

**Verification Process**:

1. Files modified: `src/lib/email/send.ts`
2. Run verification commands:
    - `tsc --noEmit`
    - `npx eslint --fix src/lib/email/send.ts`
    - `npx prettier --write src/lib/email/send.ts`
    - `npx vitest related run src/lib/email/send.ts`
3. All verifications must pass before proceeding
4. If failures persist beyond 3 attempts, stop and ask for human guidance

---

### Step 6: Write test for email test utility (TDD Red)

**What**: Create test file for email testing utility

**Why**: Need to test the test utility to ensure it properly validates email sending

**Test File**: `__tests__/lib/email/test-email.test.ts`

**Test Cases**:

- Should export sendTestAdminEmail function
- Should accept order data or use default test order
- Should call sendAdminNotificationEmail with correct parameters
- Should return EmailResult with success/error status
- Should handle missing configuration gracefully
- Should log test email sending attempt

**SOLID Principles**:

- **SRP**: Test focuses only on test email utility behavior
- **ISP**: Tests only the test utility interface

**TDD Phase**: Red (tests will fail - implementation doesn't exist yet)

**Verification Process**:

1. After writing tests, run: `npx vitest related run __tests__/lib/email/test-email.test.ts`
2. Verify tests FAIL as expected
3. If tests pass unexpectedly, review test logic
4. If more than 3 attempts needed, escalate for human guidance

---

### Step 6: Implement email test utility (TDD Green)

**What**: Create `src/lib/email/test-email.ts` with test email sending function

**Why**: Allows admin to manually trigger test emails to verify configuration without waiting for an actual order

**Implementation**:

- Create `sendTestAdminEmail()` function
- Use default test order data or accept custom order
- Call `sendAdminNotificationEmail()` with test data
- Log test email attempt
- Return `EmailResult`

**Dependencies**: Requires Step 6 (tests written first)

**SOLID Principles**:

- **SRP**: Function has single job - send test admin email
- **DIP**: Depends on `sendAdminNotificationEmail()` abstraction
- **OCP**: Can be extended to test other email types without modification

**TDD Phase**: Green (implement minimum code to make tests pass)

**Verification Process**:

1. Files modified: `src/lib/email/test-email.ts`
2. Run verification commands:
    - `tsc --noEmit`
    - `npx eslint --fix src/lib/email/test-email.ts`
    - `npx prettier --write src/lib/email/test-email.ts`
    - `npx vitest related run src/lib/email/test-email.ts`
3. All verifications must pass before proceeding
4. If failures persist beyond 3 attempts, stop and ask for human guidance

---

### Step 8: Write test for test email API route (TDD Red)

**What**: Create test file for API route that sends test admin emails

**Why**: Need automated tests for the API endpoint before implementing it

**Test File**: `__tests__/app/api/admin/test-email/route.test.ts`

**Test Cases**:

- Should require authentication (return 401 for unauthenticated requests)
- Should return 200 and success message when email sent successfully
- Should return 500 with error when email sending fails
- Should validate request method (only POST allowed)
- Should handle missing email configuration gracefully
- Should call sendTestAdminEmail function

**SOLID Principles**:

- **SRP**: Tests focus on API endpoint behavior only
- **ISP**: Tests only HTTP interface, not email sending logic

**TDD Phase**: Red (tests will fail - route doesn't exist yet)

**Verification Process**:

1. After writing tests, run: `npx vitest related run __tests__/app/api/admin/test-email/route.test.ts`
2. Verify tests FAIL as expected
3. If tests pass unexpectedly, review test logic
4. If more than 3 attempts needed, escalate for human guidance

---

### Step 8: Implement test email API route (TDD Green)

**What**: Create `src/app/api/admin/test-email/route.ts` API endpoint

**Why**: Provides admin dashboard with ability to send test emails via HTTP request

**Implementation**:

- Create POST handler
- Check authentication (admin only)
- Call `sendTestAdminEmail()`
- Return appropriate HTTP status codes
- Handle errors gracefully
- Log test email requests

**Dependencies**: Requires Step 8 (tests written first), Step 7 (test-email.ts exists)

**SOLID Principles**:

- **SRP**: Route handler only handles HTTP concerns, delegates email sending to utility
- **DIP**: Depends on `sendTestAdminEmail()` abstraction
- **OCP**: Can be extended with different test email types without modifying handler

**TDD Phase**: Green (implement minimum code to make tests pass)

**Verification Process**:

1. Files modified: `src/app/api/admin/test-email/route.ts`
2. Run verification commands:
    - `tsc --noEmit`
    - `npx eslint --fix src/app/api/admin/test-email/route.ts`
    - `npx prettier --write src/app/api/admin/test-email/route.ts`
    - `npx vitest related run src/app/api/admin/test-email/route.ts`
3. All verifications must pass before proceeding
4. If failures persist beyond 3 attempts, stop and ask for human guidance

---

### Step 10: Create email troubleshooting documentation

**What**: Create `.docs/EMAIL_TROUBLESHOOTING.md` with comprehensive troubleshooting guide

**Why**: Helps operators diagnose and fix email delivery issues independently

**Documentation Sections**:

1. Email Configuration (siteConfig.email and siteConfig.artist.email)
2. Required Environment Variables (only RESEND_API_KEY)
3. Verifying Email Configuration
4. Testing Email Delivery
5. Common Issues and Solutions
6. Resend Dashboard Verification
7. DNS Configuration (SPF, DKIM, DMARC)
8. Spam Filter Troubleshooting
9. Production Deployment Checklist

**TDD Cycle**: Not applicable (documentation)

**SOLID Principles**: Not applicable (documentation)

**Verification Process**:

1. Files created: `.docs/EMAIL_TROUBLESHOOTING.md`
2. Run verification commands:
    - `npx prettier --write .docs/EMAIL_TROUBLESHOOTING.md`
3. Manual review for clarity and completeness
4. If issues found, revise documentation

---

### Step 11: Update existing documentation references

**What**: Update `.docs/INDEX.md` and `CLAUDE.md` to reference new email troubleshooting guide

**Why**: Ensures documentation is discoverable and integrated with existing docs

**Files to Update**:

- `.docs/INDEX.md`: Add EMAIL_TROUBLESHOOTING.md to index
- `CLAUDE.md`: Add reference to email configuration section

**TDD Cycle**: Not applicable (documentation)

**SOLID Principles**: Not applicable (documentation)

**Verification Process**:

1. Files modified: `.docs/INDEX.md`, `CLAUDE.md`
2. Run verification commands:
    - `npx prettier --write .docs/INDEX.md CLAUDE.md`
3. Manual review for accuracy
4. If issues found, revise documentation

---

### Step 12: Manual testing - Verify email configuration in development

**What**: Manually test refactored email sending and test email functionality in local development environment

**Why**: Ensures the implementation works end-to-end before committing

**Manual Testing Scenarios**:

1. **Verify siteConfig Integration**:
    - Start dev server: `npm run dev`
    - Verify no errors related to email configuration
    - Confirm emails use `siteConfig.artist.email` as admin recipient
    - Confirm emails use `siteConfig.email.fromAddress` and `siteConfig.email.fromName`

2. **Test Email Sending** (requires valid Resend API key):
    - Navigate to `http://localhost:3000/api/admin/test-email` (POST request via tool like Postman or curl)
    - Verify response indicates email sent
    - Check Resend dashboard for sent email
    - Check `joe@yeoldeartoonist.com` inbox for test email
    - Verify email renders correctly with proper from/to addresses
    - Verify admin dashboard link works

3. **Test with Missing Configuration**:
    - Remove `RESEND_API_KEY` from `.env.local`
    - Attempt to send test email
    - Verify appropriate error returned
    - Verify error logged to console

4. **Test Spam Filter Scenarios**:
    - Send test email
    - Check spam/junk folders
    - Verify SPF/DKIM headers in received email
    - Document any deliverability issues

**Success Criteria**:

- Configuration validation works correctly
- Test emails send successfully
- Emails arrive in inbox (not spam)
- Error handling works as expected
- Logging provides useful debugging information

**TDD Cycle**: Not applicable (manual testing)

**SOLID Principles**: Not applicable (manual testing)

**Verification**: Manual verification by tester

---

### Step 13: Run full build verification

**What**: Run complete build pipeline to ensure no regressions

**Why**: Catches any issues before creating PR

**Commands**:

```bash
npm run build:full
```

This runs:

1. TypeScript type checking (`tsc --noEmit`)
2. ESLint (`npm run lint`)
3. All tests (`npm test`)
4. Next.js build (`npm run build`)

**Dependencies**: All previous steps must be complete

**SOLID Principles**: Not applicable (build verification)

**TDD Cycle**: Not applicable (build verification)

**Verification Process**:

1. Run `npm run build:full`
2. All checks must pass
3. If any failures occur:
    - Review error messages
    - Fix issues
    - Re-run verification
4. If failures persist beyond 3 attempts, stop and ask for human guidance

---

### Step 14: Request human review of all local changes

**What**: Present all changes to human for review before creating PR

**Why**: Ensures changes meet requirements and quality standards

**Review Checklist**:

- All tests passing
- Code follows project conventions
- Documentation is clear and complete
- No sensitive data exposed in logs
- Email template renders correctly
- Configuration validation works
- Test email functionality works
- Troubleshooting guide is comprehensive

**TDD Cycle**: Not applicable (human review)

**SOLID Principles**: Not applicable (human review)

**Verification**: Human approval required before proceeding

---

### Step 15: Create Pull Request

**What**: Create PR with all changes

**Why**: Code review and merge into main branch

**PR Title**: "refactor: Move email config to siteConfig and add test utilities for admin notifications (Issue #107)"

**PR Description**:

```markdown
## Summary

Refactors email configuration to use centralized `siteConfig` instead of environment variables, and adds testing utilities to verify admin email notifications work correctly.

**Note**: The admin notification functionality was already fully implemented in the codebase. This PR improves configuration architecture and adds testing tooling.

## Changes

### Architecture Improvements

- **Moved email configuration from environment variables to `siteConfig`**:
    - Admin email now uses `siteConfig.artist.email` (eliminates duplication)
    - Added `siteConfig.email.fromAddress` and `siteConfig.email.fromName`
    - Only `RESEND_API_KEY` remains as environment variable (actual secret)
    - Benefits: Type safety, centralized config, simpler deployment

### New Files

- `src/lib/email/test-email.ts` - Test email sending utility
- `src/app/api/admin/test-email/route.ts` - API endpoint for sending test emails
- `.docs/EMAIL_TROUBLESHOOTING.md` - Comprehensive email troubleshooting guide
- `__tests__/lib/email/test-email.test.ts` - Tests for test email utility
- `__tests__/app/api/admin/test-email/route.test.ts` - Tests for API route

### Modified Files

- `src/config/site.ts` - Added email configuration section
- `src/lib/email/send.ts` - Refactored to use siteConfig instead of environment variables
- `.env.example` - Removed `ADMIN_EMAIL`, `EMAIL_FROM_ADDRESS`, `EMAIL_FROM_NAME`
- `__tests__/lib/email/send.test.ts` - Updated tests for siteConfig usage
- `.docs/INDEX.md` - Added reference to email troubleshooting guide
- `CLAUDE.md` - Added reference to email configuration

## Testing

- [x] All existing tests pass
- [x] Updated tests for siteConfig refactoring
- [x] New unit tests added for test email functionality
- [x] Manual testing completed in development environment
- [x] Email delivery verified to joe@yeoldeartoonist.com
- [x] Verified proper from/to addresses in sent emails

## Verification for Production

After deploying this PR, verify:

1. `RESEND_API_KEY` is set in production environment (only required env var)
2. Resend domain DNS records are configured (SPF, DKIM, DMARC)
3. Send test email via `/api/admin/test-email` endpoint
4. Verify email arrives at joe@yeoldeartoonist.com (not spam)
5. Verify from address is orders@yeoldeartoonist.com

See `.docs/EMAIL_TROUBLESHOOTING.md` for detailed verification steps.

## Related Issues

Closes #107
```

**Dependencies**: Requires Step 14 (human approval)

**TDD Cycle**: Not applicable (PR creation)

**SOLID Principles**: Not applicable (PR creation)

**Verification**: PR created successfully

---

### Step 16: After PR approval, squash and merge

**What**: Merge PR into main branch using squash merge

**Why**: Keeps git history clean while preserving all changes

**Commands** (via GitHub UI or CLI):

```bash
gh pr merge --squash --delete-branch
```

**Dependencies**: Requires PR approval from reviewer

**TDD Cycle**: Not applicable (merge step)

**SOLID Principles**: Not applicable (merge step)

**Verification**: Branch merged and deleted successfully

---

## Verification Process

After each implementation step, the following verification procedure must be followed:

### Verification Commands

1. **TypeScript Compile Check**: `tsc --noEmit`
    - Runs project-wide type checking
    - Must pass with zero errors

2. **ESLint**: `npx eslint --fix {files}`
    - Replace `{files}` with space-separated paths of modified files
    - Auto-fixes formatting issues
    - Must pass with zero errors and warnings

3. **Prettier**: `npx prettier --write {files}`
    - Replace `{files}` with space-separated paths of modified files
    - Formats code to project standards
    - Must complete without errors

4. **Vitest**: `npx vitest related run {files}`
    - Replace `{files}` with space-separated paths of modified files
    - Runs tests related to changed files
    - All tests must pass

### Verification Steps

1. Identify the specific file paths modified in the current step
2. Run verification commands, replacing `{files}` with actual file paths
3. If any command fails:
    - Fix the specific error
    - Retry the verification step
4. If failures persist beyond 3 attempts:
    - Stop implementation
    - Document the issue
    - Ask for human guidance
5. Only proceed to next step when ALL verifications pass

### Example

If Step 3 modifies `src/lib/email/config-validation.ts`, run:

```bash
tsc --noEmit
npx eslint --fix src/lib/email/config-validation.ts
npx prettier --write src/lib/email/config-validation.ts
npx vitest related run src/lib/email/config-validation.ts
```

## Testing Strategy

### TDD Approach

This implementation follows strict Test-Driven Development:

1. **Red Phase**: Write failing tests first
    - Steps 4, 6, 8: Write/update tests before implementation
    - Verify tests fail as expected
    - Defines expected behavior through tests

2. **Green Phase**: Implement minimum code to pass tests
    - Steps 5, 7, 9: Write implementation code
    - Run tests frequently
    - Stop when tests pass

3. **Refactor Phase**: Maintain test coverage through refactoring
    - Step 5: Refactor send.ts to use siteConfig
    - Run tests after each change
    - Maintain test coverage

### Unit Tests (Written FIRST)

**Email Service Updates** (`__tests__/lib/email/send.test.ts` - updated):

- Updated to work with siteConfig instead of environment variables
- Verify admin email uses `siteConfig.artist.email`
- Verify from address uses `siteConfig.email.fromAddress` and `siteConfig.email.fromName`
- Keep RESEND_API_KEY validation tests
- Remove tests for removed environment variables

**Test Email Utility** (`__tests__/lib/email/test-email.test.ts`):

- Function signature and exports
- Default order data handling
- Email sending invocation
- Error handling and logging

**API Route** (`__tests__/app/api/admin/test-email/route.test.ts`):

- Authentication requirements
- HTTP method validation
- Success response format
- Error response format
- Integration with test-email utility

### Integration Tests

**Email Sending Flow**:

- siteConfig â†’ email service â†’ Resend API
- Test email endpoint â†’ test utility â†’ email service
- Webhook â†’ order creation â†’ email sending (using siteConfig)

### Manual Testing Scenarios (For UI/UX Validation)

See Step 12 for detailed manual testing scenarios:

- Verify siteConfig integration during startup
- Test email sending via API
- Error handling with missing RESEND_API_KEY
- Email deliverability and spam filtering
- Verify proper from/to addresses in sent emails

### Test Data Requirements

**Mock Order Data**: Already exists in `__tests__/lib/email/send.test.ts:26-68`

- Reuse existing `mockOrder` for consistency
- Create `testOrder` variation for test email utility

**Configuration**:

- siteConfig provides email addresses (always available)
- Test with missing/present RESEND_API_KEY

### Test Coverage Goals

- Aim for **100% coverage** of new code:
    - `test-email.ts`: All function branches covered
    - `route.ts`: All HTTP response scenarios covered
- Maintain existing coverage on modified files (no regression)
- Updated tests for send.ts refactoring must all pass

### Regression Tests

**Existing Functionality**:

- All existing email tests must continue passing
- Webhook handler tests must continue passing
- Order creation tests must continue passing
- No breaking changes to existing email sending behavior

## Considerations

### Security Implications

1. **Test Email Endpoint**:
    - MUST require admin authentication
    - MUST NOT expose sensitive configuration in responses
    - MUST rate-limit to prevent abuse
    - SHOULD log all test email requests for audit trail

2. **Configuration Validation**:
    - MUST NOT log API keys or secrets
    - SHOULD log configuration status only
    - MUST sanitize error messages (no sensitive data)

3. **Email Content**:
    - Already follows secure practices (uses React Email escaping)
    - No changes to existing email templates needed
    - Links to admin dashboard already secured by authentication

### Performance Impacts

**Minimal Performance Impact**:

- Configuration validation runs once at startup (negligible)
- Test email endpoint only used manually (not in hot path)
- No changes to webhook handler (existing parallel email sending unchanged)
- Email sending remains non-blocking (failures don't delay order creation)

### Database Migrations

**Not Required**: No database schema changes needed for this issue.

### Backward Compatibility

**Fully Backward Compatible**:

- No changes to existing email function signatures
- No changes to webhook handler behavior
- New utilities are additive only
- Existing code continues to work unchanged
- Configuration defaults maintain existing behavior

### Documentation Updates Needed

1. **New Documentation**:
    - `.docs/EMAIL_TROUBLESHOOTING.md` - Comprehensive troubleshooting guide

2. **Updated Documentation**:
    - `.docs/INDEX.md` - Add reference to email troubleshooting
    - `CLAUDE.md` - Add email configuration section reference

3. **Documentation Content**:
    - Email configuration in siteConfig (siteConfig.email and siteConfig.artist.email)
    - Environment variable requirements (only RESEND_API_KEY)
    - Email configuration verification steps
    - Test email sending instructions
    - DNS configuration for Resend
    - Spam filter troubleshooting
    - Production deployment checklist
    - Common issues and solutions

## Post-Implementation Verification

After merging this PR, the following verification steps should be performed in production:

### Production Checklist

1. **Environment Variables**:
    - [ ] Verify `RESEND_API_KEY` is set and valid (only required env var)

2. **Site Configuration**:
    - [ ] Verify `siteConfig.artist.email` is set to `joe@yeoldeartoonist.com`
    - [ ] Verify `siteConfig.email.fromAddress` is set to `orders@yeoldeartoonist.com`
    - [ ] Verify `siteConfig.email.fromName` is set to `Ye Olde Artoonist`

3. **DNS Configuration** (Resend Dashboard):
    - [ ] Verify SPF record is configured for yeoldeartoonist.com
    - [ ] Verify DKIM record is configured
    - [ ] Verify DMARC record is configured
    - [ ] Verify domain is verified in Resend dashboard

4. **Email Delivery Testing**:
    - [ ] Send test email via `/api/admin/test-email` endpoint
    - [ ] Verify email arrives at joe@yeoldeartoonist.com
    - [ ] Verify from address is orders@yeoldeartoonist.com
    - [ ] Verify email not in spam folder
    - [ ] Verify email renders correctly
    - [ ] Verify admin dashboard link works

5. **Live Order Testing**:
    - [ ] Place a test order on production
    - [ ] Verify customer confirmation email sent
    - [ ] Verify admin notification email sent
    - [ ] Verify both emails arrive in inbox
    - [ ] Verify both emails have correct from/to addresses
    - [ ] Verify order details are correct in admin email

6. **Monitoring**:
    - [ ] Check application logs for any email-related errors on startup
    - [ ] Monitor Resend dashboard for delivery rates
    - [ ] Set up alerts for email sending failures
    - [ ] Document any issues in `.docs/EMAIL_TROUBLESHOOTING.md`

### Troubleshooting Common Issues

If admin emails are not being received after deployment:

1. **Check siteConfig**: Verify email configuration in `src/config/site.ts` is correct
2. **Check Resend API Key**: Ensure `RESEND_API_KEY` is set in production environment
3. **Check Resend Dashboard**: Verify emails are being sent (check "Logs" section)
4. **Check Spam Folder**: Emails may be filtered as spam initially
5. **Check DNS Records**: Verify SPF/DKIM/DMARC are properly configured
6. **Send Test Email**: Use `/api/admin/test-email` endpoint to test independently
7. **Review Logs**: Check application logs for email sending errors
8. **Consult Documentation**: See `.docs/EMAIL_TROUBLESHOOTING.md` for detailed steps

---

## Summary

This implementation plan addresses Issue #107 by refactoring email configuration architecture and adding testing capabilities for the already-implemented admin email notification system.

**Key Points**:

- Admin notification functionality is **already fully implemented** in the codebase
- The issue is likely a **configuration or delivery problem**, not missing code
- **Architectural improvement**: Moves email config from environment variables to centralized `siteConfig`
- Uses `siteConfig.artist.email` for admin email (eliminates duplication)
- Only `RESEND_API_KEY` remains as environment variable (actual secret)
- This plan adds **testing utilities and documentation** to diagnose and fix email issues
- Implementation follows **TDD principles** with tests written/updated before code
- All new code adheres to **SOLID principles**
- Refactoring maintains **backward compatibility** (same email functionality, better architecture)
- Verification procedures ensure **quality at each step**
- Comprehensive documentation enables **self-service troubleshooting**

**Next Steps**: Await human approval before proceeding with implementation.
