# Implementation Plan: Admin Order Form Item Display Enhancement

**GitHub Issue:** #65
**Title:** Admin order form should show item name, sku, and image, not the DB id
**Created:** 2026-01-08T15:48:43
**Status:** âœ… Completed
**Completed:** 2026-01-11

---

## Overview

### Problem Statement

The admin order detail page (`/admin/orders/[id]`) currently displays only the database ID for ordered items (e.g., "Item {artwork_id}"). Site administrators need to see human-recognizable information (item name, SKU, and thumbnail image) to efficiently identify items for delivery and fulfillment.

### Goals

1. Replace database ID display with meaningful item information (title, SKU, thumbnail)
2. Maintain existing functionality (quantity, pricing, totals)
3. Handle edge cases gracefully (missing artwork, missing images, missing SKU)
4. Ensure type safety across the stack
5. Keep performance impact minimal (efficient database queries)

### Success Criteria

- âœ… Admin order detail page shows artwork title, SKU, and thumbnail for each order item
- âœ… Database ID is no longer visible in the UI
- âœ… All existing order information remains functional
- âœ… All TypeScript type checks pass
- âœ… All ESLint rules pass
- âœ… All formatting rules (Prettier) pass
- âœ… All tests pass with high coverage of new code
- âœ… Graceful handling of missing/deleted artwork

### Estimated Complexity

**Medium** - Requires database query modification, TypeScript type updates, component updates, and comprehensive testing, but follows established patterns in the codebase.

---

## Technical Approach

### Architectural Decisions

#### 1. Database Query Strategy

**Decision:** Enhance the `getOrderById` query in `src/lib/db/admin/orders.ts` to include artwork details via Supabase join.

**Rationale:**

- Supabase supports nested queries with `select('*, order_items(*, artwork(*))')`
- Fetching data in a single query is more efficient than N+1 queries
- Server-side data fetching aligns with Next.js App Router best practices
- Admin queries already use service role client, so RLS is not a concern

**Alternatives Considered:**

- Client-side fetching: Rejected due to performance and complexity
- Separate queries per item: Rejected due to N+1 query problem

#### 2. Type Safety Strategy

**Decision:** Extend TypeScript types to include artwork details in order items.

**Rationale:**

- Type safety prevents runtime errors
- TypeScript will catch mismatches between query and component usage
- Follows existing type patterns in the codebase (e.g., `OrderWithItems`)

#### 3. UI/UX Strategy

**Decision:** Display thumbnail image (64x64px), title (as link to `/shoppe/{slug}`), and SKU in the order items table.

**Rationale:**

- Visual identification (thumbnail) is fastest for fulfillment staff
- 64x64px size provides clear preview without overwhelming the layout
- Title provides full context
- SKU is critical for warehouse/inventory systems
- Links to shoppe detail page (`/shoppe/{slug}`) enable quick reference to the product listing
- Component extraction (`OrderItemRow`) improves maintainability

**Confirmed Specifications:**

- Thumbnail size: 64x64px
- Artwork link destination: `/shoppe/{slug}`
- Missing SKU fallback text: "N/A"
- Component structure: Extract `OrderItemRow` as separate component

**Fallback Handling:**

- Missing artwork: Display "Item Unavailable (ID: {artwork_id})" with warning styling
- Missing thumbnail: Display placeholder div with "No Image" text
- Missing SKU: Display "N/A" in SKU column

---

## SOLID Principles Application

### Single Responsibility Principle (SRP)

- **`getOrderById` function:** Responsible only for fetching order data with related information
- **`OrderItemRow` interface:** Represents only order item data structure
- **Component rendering:** UI components handle only presentation logic, not data fetching

### Open/Closed Principle (OCP)

- **Type extensions:** We extend `OrderItemRow` interface rather than modifying the base database types
- **Component design:** The page component can be extended to show additional artwork fields without modifying core logic

### Liskov Substitution Principle (LSP)

- **Type compatibility:** Enhanced `OrderItemRow` with artwork details remains compatible with existing type contracts
- **Nullable artwork:** Using `artwork | null` ensures type safety when artwork might be missing

### Interface Segregation Principle (ISP)

- **Artwork selection:** Only select necessary artwork fields (title, sku, image_thumbnail_url, slug) rather than full artwork record
- **Type definitions:** Create specific interfaces for order display needs, not reusing overly broad types

### Dependency Inversion Principle (DIP)

- **Database abstraction:** UI components depend on query function abstractions, not direct Supabase client usage
- **Type abstractions:** Components depend on TypeScript interfaces, not concrete database schema

---

## Implementation Steps

### Step 0: Create Feature Branch

```bash
git checkout -b issue-65
```

**Why:** Isolate changes for clean PR and easy rollback if needed.

---

### Step 1: Write Tests for Enhanced Database Query (TDD Red Phase)

**Files to Create/Modify:**

- `__tests__/lib/db/admin/orders.test.ts` (create new test file)

**Test Cases to Write:**

1. **Unit Tests:**
    - `getOrderById` should return order with order_items including artwork details
    - `getOrderById` should handle orders with missing/deleted artwork gracefully
    - `getOrderById` should only select necessary artwork fields (title, sku, image_thumbnail_url, slug)
    - `getOrderById` should return proper type structure matching `OrderWithItemsAndArtwork`

2. **Type Tests:**
    - Verify `OrderItemWithArtwork` type has correct shape
    - Verify `OrderWithItemsAndArtwork` type has correct shape
    - Verify nullable artwork field is properly typed

**TDD Red Phase:** These tests should fail initially because the implementation doesn't exist yet.

**Verification:**

```bash
tsc --noEmit
npx eslint --fix __tests__/lib/db/admin/orders.test.ts
npx prettier --write __tests__/lib/db/admin/orders.test.ts
npx vitest related run __tests__/lib/db/admin/orders.test.ts
```

**Expected Result:** Tests compile but fail (Red phase). If verification commands fail:

- Fix compile/lint/format errors immediately
- Retry verification
- After 3 failed attempts, escalate to human for guidance

**SOLID Applied:**

- **SRP:** Tests focus solely on verifying database query behavior
- **DIP:** Tests depend on function contracts, not implementation details

---

### Step 2: Update TypeScript Types (TDD Green Phase - Part 1)

**Files to Modify:**

- `src/lib/db/admin/orders.ts`

**Changes:**

1. Add new interface `OrderItemWithArtwork`:

    ```typescript
    export interface OrderItemWithArtwork extends OrderItemRow {
        artwork: {
            title: string;
            sku: string | null;
            image_thumbnail_url: string | null;
            slug: string;
        } | null;
    }
    ```

2. Add new interface `OrderWithItemsAndArtwork`:
    ```typescript
    export interface OrderWithItemsAndArtwork
        extends Omit<OrderRow, 'order_items'> {
        order_items: OrderItemWithArtwork[];
    }
    ```

**Rationale:**

- Extends existing types rather than modifying them (OCP)
- Nullable artwork handles edge case of deleted/missing artwork
- Only includes necessary artwork fields (ISP)

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/lib/db/admin/orders.ts
npx prettier --write src/lib/db/admin/orders.ts
npx vitest related run src/lib/db/admin/orders.ts
```

**Expected Result:** Types compile successfully. Tests should now compile but still fail on assertions.

**SOLID Applied:**

- **OCP:** Extended types via composition, not modification
- **ISP:** Only artwork fields needed for display are included
- **LSP:** New types are compatible with existing type hierarchy

---

### Step 3: Enhance Database Query Function (TDD Green Phase - Part 2)

**Files to Modify:**

- `src/lib/db/admin/orders.ts`

**Changes:**

1. Modify `getOrderById` query to include artwork details:

    ```typescript
    const { data, error } = await supabase
        .from('orders')
        .select(
            `
            *,
            order_items (
                id,
                order_id,
                artwork_id,
                quantity,
                price_at_purchase,
                line_subtotal,
                created_at,
                artwork (
                    title,
                    sku,
                    image_thumbnail_url,
                    slug
                )
            )
        `
        )
        .eq('id', id)
        .single();
    ```

2. Update return type of `getOrderById`:
    ```typescript
    export async function getOrderById(id: string): Promise<{
        data: OrderWithItemsAndArtwork | null;
        error: OrderAdminError | null;
    }>;
    ```

**Rationale:**

- Single query with join is more efficient than N+1 queries
- Server-side query leverages Supabase's query capabilities
- Only necessary fields are selected to minimize payload size (ISP)

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/lib/db/admin/orders.ts
npx prettier --write src/lib/db/admin/orders.ts
npx vitest related run src/lib/db/admin/orders.ts __tests__/lib/db/admin/orders.test.ts
```

**Expected Result:** Tests should now pass (Green phase). If any verification fails, fix and retry up to 3 times.

**SOLID Applied:**

- **SRP:** Function responsible only for data fetching
- **OCP:** Query can be extended for additional fields without modifying structure
- **ISP:** Only necessary artwork fields are fetched

---

### Step 4: Refactor and Optimize Query (TDD Refactor Phase)

**Files to Review:**

- `src/lib/db/admin/orders.ts`

**Refactoring Opportunities:**

1. Review query performance implications (ensure indexes exist on foreign keys)
2. Consider extracting artwork field selection into a constant for reusability
3. Ensure error handling covers edge cases (missing artwork, database errors)
4. Add JSDoc comments explaining the artwork join behavior

**Example Refactor:**

```typescript
const ARTWORK_FIELDS = `
    title,
    sku,
    image_thumbnail_url,
    slug
` as const;

// Use in query:
.select(`
    *,
    order_items (
        id,
        order_id,
        artwork_id,
        quantity,
        price_at_purchase,
        line_subtotal,
        created_at,
        artwork (${ARTWORK_FIELDS})
    )
`)
```

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/lib/db/admin/orders.ts
npx prettier --write src/lib/db/admin/orders.ts
npx vitest related run src/lib/db/admin/orders.ts __tests__/lib/db/admin/orders.test.ts
```

**Expected Result:** All tests still pass after refactoring. Code is cleaner and more maintainable.

**SOLID Applied:**

- **OCP:** Constant extraction makes adding fields easier
- **DRY:** Field selection can be reused if needed elsewhere

---

### Step 5: Write Tests for UI Component Changes (TDD Red Phase)

**Files to Create/Modify:**

- `__tests__/app/admin/orders/[id]/page.test.tsx` (create new test file)

**Test Cases to Write:**

1. **Component Rendering Tests:**
    - Should display artwork title for each order item
    - Should display artwork SKU for each order item (or "N/A" if missing)
    - Should display artwork thumbnail for each order item
    - Should display "Item Unavailable" when artwork is null
    - Should display placeholder when thumbnail is missing
    - Should link artwork title to artwork detail page
    - Should not display database ID in the UI

2. **Edge Case Tests:**
    - Order with all items having complete artwork data
    - Order with some items missing artwork (deleted artwork)
    - Order with items missing SKU
    - Order with items missing thumbnail
    - Order with no items

**TDD Red Phase:** These tests should fail because the component hasn't been updated yet.

**Verification:**

```bash
tsc --noEmit
npx eslint --fix __tests__/app/admin/orders/[id]/page.test.tsx
npx prettier --write __tests__/app/admin/orders/[id]/page.test.tsx
npx vitest related run __tests__/app/admin/orders/[id]/page.test.tsx
```

**Expected Result:** Tests compile but fail (Red phase).

**SOLID Applied:**

- **SRP:** Tests verify only UI rendering behavior, not data fetching

---

### Step 6: Update Order Detail Page Component (TDD Green Phase)

**Files to Modify:**

- `src/app/admin/orders/[id]/page.tsx`

**Changes:**

1. Update `OrderDetailClient` prop type to accept `OrderWithItemsAndArtwork`:

    ```typescript
    import type { OrderWithItemsAndArtwork } from '@/lib/db/admin/orders';
    ```

2. Modify order items table structure to include image, title, and SKU columns:
    ```tsx
    <table className="min-w-full divide-y divide-gray-200">
        <thead>
            <tr>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    Item
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    SKU
                </th>
                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Quantity
                </th>
                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Price
                </th>
                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Subtotal
                </th>
            </tr>
        </thead>
        <tbody className="divide-y divide-gray-200">
            {order.order_items.map((item) => (
                <tr key={item.id}>
                    <td className="px-4 py-4">
                        <div className="flex items-center gap-3">
                            {item.artwork ? (
                                <>
                                    {item.artwork.image_thumbnail_url ? (
                                        <img
                                            src={
                                                item.artwork.image_thumbnail_url
                                            }
                                            alt={item.artwork.title}
                                            className="w-16 h-16 object-cover rounded"
                                        />
                                    ) : (
                                        <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400 text-xs">
                                            No Image
                                        </div>
                                    )}
                                    <Link
                                        href={`/shoppe/${item.artwork.slug}`}
                                        className="text-indigo-600 hover:text-indigo-900"
                                    >
                                        {item.artwork.title}
                                    </Link>
                                </>
                            ) : (
                                <span className="text-red-600">
                                    Item Unavailable (ID: {item.artwork_id})
                                </span>
                            )}
                        </div>
                    </td>
                    <td className="px-4 py-4 text-gray-900">
                        {item.artwork?.sku || 'N/A'}
                    </td>
                    <td className="px-4 py-4 text-right text-gray-900">
                        {item.quantity}
                    </td>
                    <td className="px-4 py-4 text-right text-gray-900">
                        ${parseFloat(item.price_at_purchase).toFixed(2)}
                    </td>
                    <td className="px-4 py-4 text-right text-gray-900">
                        ${parseFloat(item.line_subtotal).toFixed(2)}
                    </td>
                </tr>
            ))}
        </tbody>
    </table>
    ```

**Rationale:**

- Visual thumbnail aids quick identification
- Title link provides navigation to item details
- SKU is essential for fulfillment/inventory
- Graceful fallbacks for missing data improve UX
- Remove database ID as it's not user-friendly

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/app/admin/orders/[id]/page.tsx
npx prettier --write src/app/admin/orders/[id]/page.tsx
npx vitest related run src/app/admin/orders/[id]/page.tsx __tests__/app/admin/orders/[id]/page.test.tsx
```

**Expected Result:** Tests should now pass (Green phase).

**SOLID Applied:**

- **SRP:** Component responsible only for rendering, not data fetching
- **OCP:** Component can be extended to show additional artwork fields
- **DIP:** Component depends on TypeScript interfaces, not database schema

---

### Step 7: Update OrderDetailClient Component Type (TDD Green Phase)

**Files to Modify:**

- `src/app/admin/orders/[id]/OrderDetailClient.tsx`

**Changes:**

1. Update import to use new type:

    ```typescript
    import {
        type OrderWithItemsAndArtwork,
        type OrderStatus,
    } from '@/lib/db/admin/orders';
    ```

2. Update interface:
    ```typescript
    interface OrderDetailClientProps {
        order: OrderWithItemsAndArtwork;
    }
    ```

**Rationale:**

- Type consistency across server and client components
- Ensures client component receives properly typed data

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/app/admin/orders/[id]/OrderDetailClient.tsx
npx prettier --write src/app/admin/orders/[id]/OrderDetailClient.tsx
npx vitest related run src/app/admin/orders/[id]/OrderDetailClient.tsx
```

**Expected Result:** All type checks pass.

**SOLID Applied:**

- **LSP:** New type is compatible with component's usage

---

### Step 8: Extract OrderItemRow Component (TDD Refactor Phase)

**Files to Create/Modify:**

- `src/app/admin/orders/[id]/OrderItemRow.tsx` (create new component)
- `src/app/admin/orders/[id]/page.tsx` (refactor to use new component)

**Required Refactoring:**

1. **Extract order item row rendering into a separate component (`OrderItemRow.tsx`)** - CONFIRMED REQUIREMENT
2. Extract fallback/placeholder logic into reusable utilities (optional enhancement)
3. Consider creating a reusable `ArtworkThumbnail` component (optional enhancement)
4. Review accessibility (alt text, ARIA labels, keyboard navigation)

**Component Extraction (Required):**

```tsx
// src/app/admin/orders/[id]/OrderItemRow.tsx
import Link from 'next/link';
import type { OrderItemWithArtwork } from '@/lib/db/admin/orders';

interface OrderItemRowProps {
    item: OrderItemWithArtwork;
}

export function OrderItemRow({ item }: OrderItemRowProps) {
    return (
        <tr>
            <td className="px-4 py-4">
                <div className="flex items-center gap-3">
                    {item.artwork ? (
                        <>
                            {item.artwork.image_thumbnail_url ? (
                                <img
                                    src={item.artwork.image_thumbnail_url}
                                    alt={item.artwork.title}
                                    className="w-16 h-16 object-cover rounded"
                                />
                            ) : (
                                <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400 text-xs">
                                    No Image
                                </div>
                            )}
                            <Link
                                href={`/shoppe/${item.artwork.slug}`}
                                className="text-indigo-600 hover:text-indigo-900"
                            >
                                {item.artwork.title}
                            </Link>
                        </>
                    ) : (
                        <span className="text-red-600">
                            Item Unavailable (ID: {item.artwork_id})
                        </span>
                    )}
                </div>
            </td>
            <td className="px-4 py-4 text-gray-900">
                {item.artwork?.sku || 'N/A'}
            </td>
            <td className="px-4 py-4 text-right text-gray-900">
                {item.quantity}
            </td>
            <td className="px-4 py-4 text-right text-gray-900">
                ${parseFloat(item.price_at_purchase).toFixed(2)}
            </td>
            <td className="px-4 py-4 text-right text-gray-900">
                ${parseFloat(item.line_subtotal).toFixed(2)}
            </td>
        </tr>
    );
}
```

**Verification:**

```bash
tsc --noEmit
npx eslint --fix src/app/admin/orders/[id]/*.tsx
npx prettier --write src/app/admin/orders/[id]/*.tsx
npx vitest related run src/app/admin/orders/[id]/*.tsx
```

**Expected Result:** All tests still pass. Code is more maintainable and reusable.

**SOLID Applied:**

- **SRP:** Each component has a single, focused responsibility
- **OCP:** Components can be extended without modifying page logic

---

### Step 9: Integration Testing

**Files to Create/Modify:**

- `__tests__/app/admin/orders/[id]/integration.test.tsx` (create new test file)

**Test Cases to Write:**

1. **End-to-End Flow:**
    - Fetch order with `getOrderById`
    - Render `OrderDetailPage` with fetched data
    - Verify all artwork details are displayed correctly
    - Verify interactions (clicking title link, etc.)

2. **Performance Tests:**
    - Verify single database query (no N+1 problem)
    - Measure query execution time (should be < 500ms)

3. **Edge Case Integration:**
    - Complete workflow with missing artwork
    - Complete workflow with partial data

**Verification:**

```bash
tsc --noEmit
npx eslint --fix __tests__/app/admin/orders/[id]/integration.test.tsx
npx prettier --write __tests__/app/admin/orders/[id]/integration.test.tsx
npx vitest related run __tests__/app/admin/orders/[id]/integration.test.tsx
```

**Expected Result:** All integration tests pass.

---

### Step 10: Manual Testing and Accessibility Audit

**Manual Testing Scenarios:**

1. **Happy Path:**
    - Navigate to `/admin/orders` (requires admin authentication)
    - Select an order with multiple items
    - Verify all item details display correctly (thumbnail, title, SKU)
    - Click on an item title link to navigate to shoppe detail page
    - Return to order page

2. **Edge Cases:**
    - View an order with deleted/missing artwork items
    - View an order with items missing SKU
    - View an order with items missing thumbnails
    - Test on various screen sizes (responsive design)

3. **Accessibility:**
    - Navigate using keyboard only (Tab, Enter)
    - Test with screen reader (NVDA/JAWS/VoiceOver)
    - Verify alt text on images
    - Check color contrast ratios (WCAG AA compliance)
    - Verify focus indicators are visible

**Documentation:**

- Document any discovered issues
- Create follow-up tickets for non-critical issues
- Take screenshots for documentation

---

### Step 11: Update Documentation (if needed)

**Files to Review/Update:**

- `.docs/ADMIN_GUIDE.md` (if it exists)
- `README.md` (if admin features are documented)
- `CLAUDE.md` (update if architectural patterns changed)

**Documentation Updates:**

- Describe order detail page enhancements
- Note that artwork details are now displayed for order items
- Document fallback behavior for missing artwork

**Verification:**

```bash
npx prettier --write .docs/*.md README.md CLAUDE.md
```

---

### Step 12: Final Verification - Run Full Test Suite

**Commands:**

```bash
# TypeScript compile check
tsc --noEmit

# Lint all modified files
npx eslint --fix src/app/admin/orders/[id]/*.tsx src/lib/db/admin/orders.ts __tests__/**/*.ts*

# Format all modified files
npx prettier --write src/app/admin/orders/[id]/*.tsx src/lib/db/admin/orders.ts __tests__/**/*.ts*

# Run all tests with coverage
npm test
```

**Expected Results:**

- âœ… TypeScript: No errors
- âœ… ESLint: No errors or warnings
- âœ… Prettier: All files formatted
- âœ… Tests: All passing with >80% coverage on new code

**If any verification fails:**

- Review failure details
- Fix issues
- Re-run verification
- If 3 attempts fail, escalate to human

---

### Step 13: Request Human Review

**Action:** Create a summary of all changes and request code review.

**Summary Format:**

```
## Changes Summary - Issue #65

### Database Layer
- Modified `getOrderById` in `src/lib/db/admin/orders.ts` to include artwork details via join
- Added TypeScript types: `OrderItemWithArtwork`, `OrderWithItemsAndArtwork`
- Query now fetches: artwork title, SKU, thumbnail, and slug

### UI Layer
- Updated `src/app/admin/orders/[id]/page.tsx` to display artwork details
- Enhanced order items table with image, title, and SKU columns
- Added fallback handling for missing artwork/SKU/thumbnails
- Removed database ID from display

### Tests
- Created unit tests for enhanced database query
- Created component tests for UI changes
- Created integration tests for end-to-end flow
- All tests passing with XX% coverage

### Verification
- âœ… TypeScript compile check: PASS
- âœ… ESLint: PASS
- âœ… Prettier: PASS
- âœ… Tests: PASS (XX/XX tests, XX% coverage)
- âœ… Manual testing: PASS

### Screenshots
[Attach screenshots of the enhanced order detail page]

### Edge Cases Handled
- Missing/deleted artwork: Shows "Item Unavailable" warning
- Missing SKU: Shows "N/A"
- Missing thumbnail: Shows placeholder

### Breaking Changes
None. This is an enhancement with backward-compatible type additions.
```

**Wait for human approval before proceeding to PR creation.**

---

### Step 14: Create Pull Request

**Prerequisites:**

- Human approval received from Step 13
- All verifications passing
- Branch up to date with main

**PR Creation:**

```bash
# Ensure all changes are committed
git add .
git commit -m "feat(admin): display artwork details in order items

- Enhanced getOrderById to include artwork details via join
- Added OrderItemWithArtwork and OrderWithItemsAndArtwork types
- Updated order detail page to show thumbnail, title, and SKU
- Removed database ID from display
- Added graceful fallbacks for missing artwork data
- Added comprehensive test coverage

Closes #65

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Push to remote
git push -u origin issue-65

# Create PR using GitHub CLI
gh pr create --title "feat(admin): display artwork details in order items" --body "$(cat <<'EOF'
## Summary
Enhances the admin order detail page to display meaningful item information (artwork title, SKU, and thumbnail) instead of just the database ID.

## Changes
- **Database Query:** Modified `getOrderById` to include artwork details via Supabase join
- **TypeScript Types:** Added `OrderItemWithArtwork` and `OrderWithItemsAndArtwork` interfaces
- **UI Enhancement:** Updated order items table to show thumbnail, title (as link), and SKU
- **Edge Cases:** Added fallbacks for missing artwork, SKU, or thumbnails

## Test Coverage
- Unit tests for enhanced database query
- Component tests for UI rendering
- Integration tests for end-to-end flow
- Manual testing completed

## Screenshots
[Attach screenshots]

## Closes
Closes #65

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

---

### Step 15: After PR Approval - Squash and Merge

**Prerequisites:**

- PR approved by human reviewer(s)
- All CI checks passing
- No merge conflicts

**Merge Process:**

```bash
# Squash and merge using GitHub CLI
gh pr merge --squash --delete-branch

# Update local main branch
git checkout main
git pull origin main

# Clean up local branch
git branch -d issue-65
```

**Post-Merge:**

- Verify deployment to production (if auto-deploy is enabled)
- Monitor for any issues in production
- Close issue #65 (should auto-close via PR merge)

---

## Verification Process

### After Each Implementation Step

**Commands to Run:**

```bash
# 1. TypeScript compile check (no file paths needed)
tsc --noEmit

# 2. ESLint (replace {files} with actual modified file paths)
npx eslint --fix {files}

# 3. Prettier (replace {files} with actual modified file paths)
npx prettier --write {files}

# 4. Vitest related tests (replace {files} with actual modified file paths)
npx vitest related run {files}
```

**Verification Steps:**

1. Identify the specific file paths modified in the current step
2. Replace `{files}` with space-separated file paths in commands 2-4
3. Run all four commands in sequence
4. If any command fails:
    - Fix the specific error
    - Retry the verification step
5. If failures persist beyond 3 attempts:
    - Stop implementation
    - Document the issue
    - Ask for human guidance
6. Only proceed to next step when ALL verifications pass

**Example:**

```bash
# Step 3 verification example
tsc --noEmit
npx eslint --fix src/lib/db/admin/orders.ts
npx prettier --write src/lib/db/admin/orders.ts
npx vitest related run src/lib/db/admin/orders.ts
```

---

## Testing Strategy

### TDD Approach

This implementation follows strict Test-Driven Development (TDD):

1. **Red Phase:** Write failing tests first (Steps 1, 5)
2. **Green Phase:** Implement minimum code to pass tests (Steps 2, 3, 6, 7)
3. **Refactor Phase:** Improve code while keeping tests passing (Steps 4, 8)

### Test Layers

#### Unit Tests

- **Purpose:** Verify individual functions in isolation
- **Files:** `__tests__/lib/db/admin/orders.test.ts`
- **Coverage Goals:** 100% of new database query code
- **Focus Areas:**
    - Query returns correct structure
    - Query includes artwork details
    - Query handles missing artwork gracefully
    - Type safety is enforced

#### Component Tests

- **Purpose:** Verify UI components render correctly
- **Files:** `__tests__/app/admin/orders/[id]/page.test.tsx`
- **Coverage Goals:** 100% of new UI rendering code
- **Focus Areas:**
    - Artwork details are displayed
    - Fallbacks work correctly
    - Links are functional
    - Database ID is not visible

#### Integration Tests

- **Purpose:** Verify end-to-end flow from database to UI
- **Files:** `__tests__/app/admin/orders/[id]/integration.test.tsx`
- **Coverage Goals:** Critical user paths
- **Focus Areas:**
    - Data flows correctly from query to UI
    - No N+1 query problems
    - Performance is acceptable
    - Edge cases work in full context

#### Manual Testing

- **Purpose:** Validate UX, accessibility, and visual design
- **Scenarios:** See Step 10
- **Focus Areas:**
    - User experience is intuitive
    - Responsive design works
    - Accessibility standards met
    - Browser compatibility

### Test Data Requirements

**Database Setup:**

- Create test orders with complete artwork data
- Create test orders with missing/deleted artwork
- Create test orders with missing SKU/thumbnails
- Ensure artwork table has test data with and without images

**Mocking Strategy:**

- Mock Supabase client for unit tests
- Use test database for integration tests
- Mock Next.js router for component tests

---

## Considerations

### Security Implications

- **Concern:** Admin-only feature, but ensure RLS policies are correct
- **Mitigation:** Use service role client (already in place)
- **Verification:** Confirm `/admin` routes are protected by middleware

### Performance Impacts

- **Concern:** Adding artwork join might slow down query
- **Mitigation:**
    - Only select necessary artwork fields
    - Ensure foreign key indexes exist (check database schema)
    - Monitor query execution time in integration tests
- **Expected Impact:** Minimal (<50ms increase for typical orders with 1-5 items)

### Database Migrations

- **Required:** No new migrations needed
- **Reason:** Using existing schema relationships
- **Verification:** Confirm `order_items.artwork_id` has foreign key to `artwork.id`

### Backward Compatibility

- **Breaking Changes:** None
- **Type Compatibility:** New types extend existing types, old types still work
- **API Compatibility:** `getOrderById` return type changes, but only used in admin pages

### Documentation Updates

- **Admin Guide:** Document new order detail display (if admin guide exists)
- **Code Comments:** Add JSDoc to explain artwork join behavior
- **CLAUDE.md:** No changes needed unless architectural patterns change

---

## Risk Assessment

### High Priority Risks

1. **Missing Artwork Data**
    - Risk: Orders with deleted artwork break the page
    - Mitigation: Nullable artwork field + fallback UI
    - Handled in: Steps 2, 6

2. **Performance Degradation**
    - Risk: Query becomes too slow with join
    - Mitigation: Integration tests measure performance
    - Handled in: Step 9

### Medium Priority Risks

1. **Type Safety Gaps**
    - Risk: Type mismatches between database and UI
    - Mitigation: Comprehensive TypeScript types
    - Handled in: Steps 2, 7

2. **Responsive Design Issues**
    - Risk: New table columns don't fit on mobile
    - Mitigation: Manual testing on various screen sizes
    - Handled in: Step 10

### Low Priority Risks

1. **Accessibility Issues**
    - Risk: Screen readers can't navigate new UI
    - Mitigation: Accessibility audit in manual testing
    - Handled in: Step 10

---

## Success Metrics

### Functional Metrics

- âœ… All acceptance criteria met (see Overview section)
- âœ… Zero regressions in existing order functionality
- âœ… All edge cases handled gracefully

### Quality Metrics

- âœ… Test coverage: >80% on new code
- âœ… Zero TypeScript errors
- âœ… Zero ESLint errors/warnings
- âœ… All files formatted per Prettier rules

### Performance Metrics

- âœ… Order detail page load time: <1 second
- âœ… Database query execution: <500ms
- âœ… No N+1 query problems

### User Experience Metrics

- âœ… Admin can identify items visually (thumbnail)
- âœ… Admin can find item SKU for fulfillment
- âœ… Admin can navigate to item detail page
- âœ… Graceful handling of missing data

---

## Rollback Plan

### If Issues Arise Post-Merge

1. **Minor Issues (display glitches, missing edge cases):**
    - Create follow-up issue
    - Fix in new PR
    - No rollback needed

2. **Major Issues (broken orders page, data errors):**
    - Revert PR merge:
        ```bash
        git revert <merge-commit-sha>
        git push origin main
        ```
    - Investigate root cause
    - Fix in new PR with additional tests
    - Re-deploy

3. **Critical Issues (security, data loss):**
    - Immediately revert PR
    - Deploy hotfix to production
    - Conduct post-mortem
    - Develop comprehensive fix with enhanced testing

---

## Design Decisions - Confirmed

All design decisions have been reviewed and confirmed:

1. **Artwork Link:** âœ… **CONFIRMED** - Link to `/shoppe/{slug}`
    - Rationale: These are purchased items from the shop, so linking to the shop page makes sense

2. **Thumbnail Size:** âœ… **CONFIRMED** - 64x64px (w-16 h-16)
    - Rationale: Provides clear preview without overwhelming the layout

3. **Missing SKU Display:** âœ… **CONFIRMED** - "N/A"
    - Rationale: Clear, concise fallback text that indicates "not available"

4. **Component Extraction:** âœ… **CONFIRMED** - Extract `OrderItemRow` as separate component
    - Rationale: Improves maintainability, testability, and follows Single Responsibility Principle

5. **Additional Fields:** âœ… **CONFIRMED** - No additional fields needed
    - Rationale: Title, SKU, and thumbnail satisfy the acceptance criteria and admin needs

---

## Timeline Estimate

**Note:** Per project guidelines, no specific timeline estimates are provided. Implementation will proceed step-by-step with verification at each stage. Complexity is rated as **Medium** based on:

- Multiple layers (database, types, UI)
- Need for comprehensive testing
- Edge case handling
- Following established patterns reduces complexity

---

## Conclusion

This plan provides a comprehensive, step-by-step approach to enhancing the admin order detail page with artwork information. The implementation follows TDD principles, SOLID design principles, and project standards. Each step includes verification commands to ensure code quality is maintained throughout.

**All design decisions have been confirmed:**

- âœ… Artwork links go to `/shoppe/{slug}`
- âœ… Thumbnail size: 64x64px
- âœ… Missing SKU displays as "N/A"
- âœ… `OrderItemRow` will be extracted as a separate component
- âœ… No additional fields beyond title, SKU, thumbnail

**Next Steps:**

1. âœ… Human review and approval of this plan - **COMPLETED**
2. Begin implementation starting at Step 0 (create branch)
3. Follow TDD cycle (Red-Green-Refactor) for each step
4. Run verification commands after each step
5. Request human review before creating PR

---

**Plan Status:** âœ… **APPROVED - Ready for Implementation**
