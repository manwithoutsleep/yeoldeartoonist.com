# Implementation Plan: Fix Broken Logo Link in Order Confirmation Email

**Issue:** #108
**Title:** Fix the broken image link in order confirmation emails
**Created:** 2026-01-17T19:43:20
**Status:** Planning

## Overview

The order confirmation email template currently references a non-existent logo file (`/logo.png`), resulting in a broken image in customer emails. The actual logo exists at `public/images/header-footer/logo.webp`. This implementation will fix the broken image reference to display the correct logo.

### Goals

- Fix the broken logo image link in the OrderConfirmation email template
- Ensure the logo displays correctly in customer order confirmation emails
- Maintain consistent branding across all customer communications

### Success Criteria

1. Logo image URL points to the correct file path
2. Logo displays properly in rendered emails
3. All existing tests pass
4. Test updated to verify correct logo URL

### Scope and Complexity

**Complexity:** Low
**Estimated Changes:** 2 files (1 source file, 1 test file)
**Risk Level:** Low - Simple path correction with existing test coverage

## Root Cause Analysis

**Current State:**

- Email template references: `${siteUrl}/logo.png` (line 48 in OrderConfirmation.tsx)
- Actual logo location: `public/images/header-footer/logo.webp`
- Test verifies logo URL includes `${siteUrl}/logo.png` (line 269 in templates.test.tsx)

**Why This Broke:**

- The logo file was placed in `public/images/header-footer/` directory structure
- Email template was likely created with assumption of logo at root of public directory
- File format is `.webp` (modern format) not `.png`

**Impact:**

- Customers receive order confirmation emails with broken logo images
- Reduced brand recognition and professionalism
- Potential confusion about email authenticity

## Technical Approach

### SOLID Principles Application

1. **Single Responsibility Principle (SRP)**
    - The OrderConfirmation component has a single responsibility: rendering order confirmation email HTML
    - This fix maintains that focus by correcting configuration data (logo path)
    - No new responsibilities added

2. **Open/Closed Principle (OCP)**
    - Component remains open for extension (could add more branding elements)
    - Closed for modification to core rendering logic (only changing data, not behavior)
    - Props interface unchanged

3. **Liskov Substitution Principle (LSP)**
    - Not applicable - no inheritance hierarchy involved
    - Component contract with parent remains identical

4. **Interface Segregation Principle (ISP)**
    - OrderConfirmationProps interface remains minimal and focused
    - Only accepts what's needed: order data and siteUrl
    - No unnecessary properties

5. **Dependency Inversion Principle (DIP)**
    - Component depends on abstractions (Order type, siteUrl string)
    - Not tightly coupled to specific logo implementation
    - Logo path is data-driven via siteUrl parameter

### Design Decisions

**Decision 1: Use WebP format instead of PNG**

- **Rationale:** The actual logo file is already in `.webp` format
- **Benefit:** WebP provides better compression and quality than PNG for email
- **Risk:** Some older email clients may not support WebP
- **Mitigation:** Most modern email clients (Gmail, Outlook, Apple Mail) support WebP; fallback handled by client alt text

**Decision 2: Keep logo in current directory structure**

- **Rationale:** Don't move existing files; update reference instead
- **Benefit:** Avoids breaking other references to logo throughout the site
- **Risk:** None - logo is already in proper location for web serving

**Decision 3: Update path to absolute public URL path**

- **Rationale:** Next.js serves files from `public/` at root URL path
- **Implementation:** Change from `/logo.png` to `/images/header-footer/logo.webp`
- **Benefit:** Correctly resolves to actual file location

### Integration Points

**Affected Components:**

1. `src/lib/email/templates/OrderConfirmation.tsx` - Source template (line 48)
2. `__tests__/lib/email/templates.test.tsx` - Test verification (line 269)

**Dependencies:**

- No external dependencies affected
- Uses existing `@react-email/components` library (no changes)
- Relies on Next.js public file serving (no changes)

### Potential Risks and Mitigation

| Risk                                      | Likelihood | Impact | Mitigation                                              |
| ----------------------------------------- | ---------- | ------ | ------------------------------------------------------- |
| Logo doesn't render in some email clients | Low        | Medium | Test in major email clients; alt text provides fallback |
| Wrong file path                           | Low        | High   | Verify file exists before deployment; automated test    |
| Cache issues with old emails              | Low        | Low    | Only affects new emails; old emails remain unchanged    |

## Implementation Steps

### Step 1: Create Feature Branch

```bash
git checkout -b issue-108
```

**Purpose:** Isolate changes for this bug fix
**SOLID Principle:** N/A (git workflow)
**Verification:** `git status` shows on issue-108 branch

---

### Step 2: Write Failing Test (TDD Red Phase)

**File:** `__tests__/lib/email/templates.test.tsx`

**Test to Add/Modify:**
Update existing test at line 265-270 to verify correct logo URL:

```typescript
it('should include logo with correct URL', async () => {
    const html = await render(OrderConfirmation({ order: mockOrder, siteUrl }));
    expect(html).toContain(`${siteUrl}/images/header-footer/logo.webp`);
});
```

**Why TDD Red Phase:**

- Establishes regression test before fixing
- Current test expects `/logo.png` which is incorrect
- New test will fail until we fix the template
- Ensures fix actually resolves the issue

**SOLID Principles:**

- SRP: Test has single responsibility - verify logo URL is correct
- DIP: Test depends on template abstraction, not implementation details

**Verification Commands:**

```bash
# Run type check
tsc --noEmit

# Lint the test file
npx eslint --fix __tests__/lib/email/templates.test.tsx

# Format the test file
npx prettier --write __tests__/lib/email/templates.test.tsx

# Run the specific test (should FAIL)
npx vitest related run __tests__/lib/email/templates.test.tsx
```

**Expected Result:** Test fails because template still references `/logo.png`

**If Verification Fails:**

- Check test syntax for TypeScript errors
- Verify test file imports are correct
- Ensure siteUrl variable is in scope
- Max 3 attempts; escalate to human if issues persist

---

### Step 3: Fix Logo URL in Email Template (TDD Green Phase)

**File:** `src/lib/email/templates/OrderConfirmation.tsx`

**Change at line 47-53:**

**Before:**

```typescript
<Img
    src={`${siteUrl}/logo.png`}
    alt="Ye Olde Artoonist"
    width="200"
    height="50"
    style={logo}
/>
```

**After:**

```typescript
<Img
    src={`${siteUrl}/images/header-footer/logo.webp`}
    alt="Ye Olde Artoonist"
    width="200"
    height="50"
    style={logo}
/>
```

**Why This Implementation:**

- Minimum code change to pass test (TDD Green phase)
- Corrects path to actual logo file location
- Maintains all other properties (alt, width, height, style)

**SOLID Principles:**

- SRP: Component maintains single responsibility (render email)
- OCP: Change is extension of data, not modification of behavior
- DIP: Still depends on siteUrl abstraction

**Verification Commands:**

```bash
# Run type check
tsc --noEmit

# Lint the source file
npx eslint --fix src/lib/email/templates/OrderConfirmation.tsx

# Format the source file
npx prettier --write src/lib/email/templates/OrderConfirmation.tsx

# Run related tests (should PASS now)
npx vitest related run src/lib/email/templates/OrderConfirmation.tsx
```

**Expected Result:** All tests pass, including the updated logo test

**If Verification Fails:**

- Verify file path is correct: `public/images/header-footer/logo.webp`
- Check for typos in path string
- Ensure no extra whitespace or characters
- Max 3 attempts; escalate to human if issues persist

---

### Step 4: Verify Logo File Exists (Manual Verification)

**Purpose:** Ensure the logo file is actually present at the expected location

**Verification Commands:**

```bash
# On Windows
dir public\images\header-footer\logo.webp

# Verify file is accessible via Next.js dev server
npm run dev
# Then open browser to: http://localhost:3000/images/header-footer/logo.webp
```

**Expected Result:** File exists and loads in browser

**If Verification Fails:**

- Check file permissions
- Verify public directory structure
- Confirm Next.js is serving static files correctly
- Escalate to human if logo file is missing

---

### Step 5: Refactor - Check for Other Logo References (TDD Refactor Phase)

**Purpose:** Ensure consistency across all email templates

**Search for other potential broken logo references:**

```bash
# Search for logo references in email templates
npx grep -r "logo.png" src/lib/email/
```

**Files to Check:**

- `src/lib/email/templates/AdminNotification.tsx` - May also reference logo

**Action:**

- If AdminNotification.tsx also uses logo, apply same fix
- Update corresponding tests
- Re-run verification suite

**SOLID Principles:**

- DRY (Don't Repeat Yourself): Ensure consistency
- SRP: Each template maintains its own rendering logic
- OCP: Any refactoring preserves existing interfaces

**Verification Commands:**

```bash
# After any changes to AdminNotification.tsx
tsc --noEmit
npx eslint --fix src/lib/email/templates/AdminNotification.tsx
npx prettier --write src/lib/email/templates/AdminNotification.tsx
npx vitest related run src/lib/email/templates/AdminNotification.tsx
```

**If No Additional Changes Needed:** Proceed to next step

---

### Step 6: Run Full Test Suite

**Purpose:** Ensure no regressions in other parts of the codebase

**Verification Commands:**

```bash
# Run full build verification
npm run build:full
```

This runs:

1. TypeScript type checking (`tsc --noEmit`)
2. ESLint (`npm run lint`)
3. Vitest (`npm test`)
4. Next.js build (`npm run build`)

**Expected Result:** All checks pass with zero errors

**If Verification Fails:**

- Review error messages for specific failures
- Fix any identified issues
- Re-run verification
- Max 3 attempts; escalate to human if persistent failures

---

### Step 7: Manual Email Rendering Test

**Purpose:** Visually verify logo appears correctly in rendered email

**Test Procedure:**

1. **Preview Email in Development:**
    - Use React Email CLI if available: `npx email dev`
    - Or create temporary test file to render email and output HTML

2. **Send Test Email (Optional):**
    - Temporarily modify webhook route to use test order data
    - Process test order through checkout
    - Verify email received with correct logo

3. **Visual Verification Checklist:**
    - [ ] Logo image loads (not broken)
    - [ ] Logo displays at correct size (200x50)
    - [ ] Logo is centered in header
    - [ ] Alt text displays if image fails to load
    - [ ] Email renders correctly in different clients (Gmail, Outlook, etc.)

**Manual Testing Notes:**

- Test in at least 2 major email clients
- Verify mobile rendering if possible
- Check both light and dark mode (if supported by client)

---

### Step 8: Request Human Review

**Purpose:** Get stakeholder approval before merging

**Review Checklist:**

- [ ] Code changes are minimal and focused
- [ ] All tests pass
- [ ] Logo displays correctly in test emails
- [ ] No other logo references need updating
- [ ] Documentation updated if needed

**Actions:**

1. Commit all changes with descriptive message
2. Push branch to remote
3. Request human to review code changes
4. Address any feedback
5. Get explicit approval to proceed

---

### Step 9: Create Pull Request

**Purpose:** Formalize code review and merge process

**PR Template:**

```markdown
## Summary

Fixes broken logo image link in order confirmation emails

## Issue

Closes #108

## Changes

- Updated logo image path from `/logo.png` to `/images/header-footer/logo.webp`
- Updated test to verify correct logo URL

## Testing

- [x] Unit tests pass
- [x] Manual email rendering verified
- [x] Logo displays correctly in test emails
- [x] No regressions in other tests

## Screenshots

[Include screenshot of email with logo displaying correctly]

## Checklist

- [x] Code follows project style guide
- [x] Tests updated and passing
- [x] No breaking changes
- [x] Documentation updated (if needed)
```

**Verification:**

```bash
# Push branch
git push -u origin issue-108

# Create PR via GitHub CLI
gh pr create --title "Fix broken logo link in order confirmation email" --body "See PR template above"
```

---

### Step 10: After PR Approval - Squash and Merge

**Purpose:** Integrate fix into main branch

**Process:**

1. Wait for PR approval from reviewer
2. Ensure all CI checks pass
3. Squash and merge via GitHub UI
4. Delete feature branch

**Post-Merge Verification:**

```bash
# Switch to main branch
git checkout main

# Pull latest changes
git pull

# Verify logo fix is present
git log --oneline -5
```

**Deployment:**

- Changes will deploy automatically via Vercel on merge to main
- Monitor deployment logs for any issues
- Verify logo displays in production emails

---

## Verification Process

After **EACH** implementation step (Steps 2-6), follow this procedure:

### Verification Commands

1. **TypeScript Compile Check:**

    ```bash
    tsc --noEmit
    ```

    - Ensures no type errors introduced
    - Must pass with zero errors

2. **ESLint:**

    ```bash
    npx eslint --fix {files}
    ```

    Replace `{files}` with space-separated paths of modified files:
    - `src/lib/email/templates/OrderConfirmation.tsx`
    - `__tests__/lib/email/templates.test.tsx`

3. **Prettier:**

    ```bash
    npx prettier --write {files}
    ```

    Same file list as ESLint

4. **Vitest:**
    ```bash
    npx vitest related run {files}
    ```
    Runs tests related to modified files

### Verification Steps

1. Identify specific file paths modified in current step
2. Run verification commands in order (tsc → eslint → prettier → vitest)
3. If any command fails:
    - Read error message carefully
    - Fix the specific error
    - Retry verification from failed step
4. If failures persist beyond 3 attempts:
    - Stop implementation
    - Document the issue in comments
    - Ask for human guidance
5. **Only proceed to next step when ALL verifications pass**

### Verification Failure Handling

**Common Issues and Solutions:**

| Issue                              | Solution                                                                    |
| ---------------------------------- | --------------------------------------------------------------------------- |
| TypeScript error: Cannot find file | Verify file path is correct; check imports                                  |
| ESLint error: Unused variable      | Remove unused variables or add `// eslint-disable-next-line` if intentional |
| Prettier formatting conflict       | Let Prettier auto-fix; commit formatted version                             |
| Test failure: Assertion error      | Verify test expectations match implementation; debug if needed              |
| Import path error                  | Check `@/` alias points to `src/` directory                                 |

**Escalation Process:**

- Attempt 1: Fix error and retry
- Attempt 2: Review error in detail, check documentation
- Attempt 3: Try alternative approach
- After 3 failures: Document issue and request human assistance

## Testing Strategy

### TDD Approach

This fix follows Test-Driven Development:

1. **Red Phase (Step 2):**
    - Write/update test to expect correct logo URL
    - Run test - it should FAIL
    - Confirms test is actually testing the bug

2. **Green Phase (Step 3):**
    - Fix logo URL in template
    - Run test - it should PASS
    - Minimum code to make test pass

3. **Refactor Phase (Step 5):**
    - Check for similar issues in other templates
    - Ensure consistency
    - Tests remain passing throughout

### Unit Tests

**Files:** `__tests__/lib/email/templates.test.tsx`

**Test Coverage:**

- ✅ Existing: Email renders without errors
- ✅ Existing: Email contains valid HTML
- ✅ Existing: Email includes order information
- ✅ **Updated:** Logo URL points to correct file path
- ✅ Existing: Alt text is present for accessibility

**Test Data:**

- Use existing `mockOrder` from test file
- Use existing `siteUrl = 'https://yeoldeartoonist.com'`

**Coverage Goals:**

- Maintain existing 100% coverage of OrderConfirmation component
- No new code paths introduced (only data change)

### Integration Tests

**File:** `__tests__/lib/email/send.test.ts`

**Verification:**

- Existing tests should continue passing
- No changes required (tests mock Resend API)
- Email sending logic unchanged

### Manual Testing Scenarios

**Scenario 1: Visual Email Preview**

- **Given:** Email template is rendered with real order data
- **When:** I preview the email in an email client
- **Then:** Logo displays correctly at top of email

**Scenario 2: Multiple Email Clients**

- **Given:** Order confirmation email is sent
- **When:** I open email in Gmail, Outlook, and Apple Mail
- **Then:** Logo displays consistently across all clients

**Scenario 3: Alt Text Fallback**

- **Given:** Email client blocks images by default
- **When:** I view email with images disabled
- **Then:** Alt text "Ye Olde Artoonist" is displayed

**Scenario 4: Mobile Rendering**

- **Given:** Email is opened on mobile device
- **When:** I view email on iPhone/Android
- **Then:** Logo scales appropriately and remains centered

### Test Data Requirements

**No New Test Data Needed:**

- Use existing `mockOrder` in test file
- Use existing `siteUrl` constant
- Logo file already exists at `public/images/header-footer/logo.webp`

### Regression Tests

**Existing Tests Must Pass:**

- All 28 OrderConfirmation template tests
- All 14 AdminNotification template tests
- Email sending service tests
- Integration tests for checkout flow

**Areas to Monitor:**

- Email rendering performance (should be unchanged)
- Email delivery success rate (should be unchanged)
- Template rendering errors (should remain zero)

## Considerations

### Security Implications

**None - No Security Impact:**

- Change is purely cosmetic (logo URL path)
- No user input involved
- No authentication/authorization changes
- No data exposure risk
- Logo file is public asset (already accessible)

### Performance Impacts

**Minimal - Slight Improvement:**

- WebP format is more efficient than PNG
- Smaller file size = faster email load time
- No additional HTTP requests
- No impact on server-side rendering time

**Benchmarks:**

- Current: Broken image (no load)
- After fix: ~10-20KB WebP image
- Impact: Negligible (~100ms on slow connections)

### Database Migrations

**None Required:**

- No database schema changes
- No data model updates
- No migration scripts needed

### Backward Compatibility

**Fully Compatible:**

- Old emails already sent: Remain unchanged (logo still broken in those)
- New emails after deployment: Will show correct logo
- No version conflicts
- No API contract changes

**Note:** Previously sent emails cannot be retroactively fixed. Only new emails will display the correct logo.

### Documentation Updates Needed

**Minimal Documentation Updates:**

1. **Update:** `.docs/TROUBLESHOOTING.md` (if it mentions email issues)
    - Add note about logo file location
    - Document correct path for email assets

2. **Update:** `CLAUDE.md` (project instructions)
    - No changes needed - already documents email templates

3. **Update:** README.md
    - No changes needed - user-facing, not developer docs

4. **Optional:** Add comment in OrderConfirmation.tsx
    ```typescript
    {/* Logo - served from public/images/header-footer/logo.webp */}
    <Img src={`${siteUrl}/images/header-footer/logo.webp`} ... />
    ```

## Summary

This is a straightforward bug fix with low complexity and minimal risk:

- **Root Cause:** Incorrect logo file path in email template
- **Solution:** Update path from `/logo.png` to `/images/header-footer/logo.webp`
- **Impact:** 2 files changed (1 source, 1 test)
- **Testing:** TDD approach with existing test infrastructure
- **Risk:** Very low - isolated change with test coverage

### Key Technical Decisions

1. Use existing logo file (don't move or copy)
2. Update template reference to match actual file location
3. Follow TDD: write failing test, fix, verify, refactor

### Implementation Time Estimate

- Step 1 (Branch): 1 minute
- Step 2 (Test): 5 minutes
- Step 3 (Fix): 2 minutes
- Step 4 (Verify file): 2 minutes
- Step 5 (Refactor): 5 minutes
- Step 6 (Full tests): 5 minutes
- Step 7 (Manual test): 10 minutes
- Step 8-10 (PR process): 15 minutes

**Total: ~45 minutes** (excluding review wait time)

### Success Metrics

- ✅ Test passes verifying correct logo URL
- ✅ All existing tests continue passing
- ✅ Logo displays in manual email preview
- ✅ No regressions in email sending functionality
- ✅ Clean git history with descriptive commit message

## Next Steps

**Awaiting Human Approval:**

Please review this implementation plan and confirm:

1. **Approach is correct:** Update logo path to `/images/header-footer/logo.webp`
2. **Test strategy is acceptable:** TDD with existing test infrastructure
3. **No additional requirements:** Logo display is the only concern (not size, positioning, etc.)

**Questions for Consideration:**

1. Should we also check AdminNotification template for logo issues?
2. Do we need to test in specific email clients before merging?
3. Should we add a fallback PNG logo for email clients that don't support WebP?
4. Is the logo file at `public/images/header-footer/logo.webp` the correct one to use?

**I will not proceed with implementation until you give explicit approval.**
