# Implementation Plan: Issue #107 - Refactor Email Configuration to siteConfig

**Issue**: #107
**Title**: When a shopper places an order, notify the site admin
**Created**: 2026-01-18T19-31-19
**Status**: Planning

## Problem Statement

Site admin is not receiving email notifications when shoppers place orders.

**Root Cause Identified**: `ADMIN_EMAIL` environment variable is not configured in production.

**Solution**: Refactor email configuration from environment variables to `siteConfig` for better maintainability and to eliminate the configuration issue.

## Current State

The admin notification functionality is **already fully implemented and tested**:

- `sendAdminNotificationEmail()` function exists (`src/lib/email/send.ts:143-221`)
- `AdminNotification.tsx` template is complete and tested
- Webhook handler calls `sendOrderEmails()` after order creation
- All tests passing

**Current Configuration** (environment variables):

- `ADMIN_EMAIL` - admin recipient address (missing in production)
- `EMAIL_FROM_ADDRESS` - sender address
- `EMAIL_FROM_NAME` - sender display name
- `RESEND_API_KEY` - API key (must remain secret)

**Proposed Configuration** (siteConfig):

- `siteConfig.artist.email` - admin recipient (already exists as `joe@yeoldeartoonist.com`)
- `siteConfig.email.fromAddress` - sender address (new)
- `siteConfig.email.fromName` - sender display name (new)
- `RESEND_API_KEY` - remains as environment variable (secret)

## Benefits of This Refactoring

1. **Eliminates Duplication**: Admin email already exists as `siteConfig.artist.email`
2. **Type Safety**: TypeScript autocomplete and compile-time validation
3. **Centralized Config**: All site configuration in one predictable place
4. **Simpler Deployment**: 3 fewer environment variables to configure
5. **Better Maintainability**: Email addresses aren't secrets and belong in code
6. **Fixes Root Cause**: Configuration always available (no missing env var issue)

## Implementation Steps

### Step 1: Create branch

```bash
git checkout -b issue-107
```

---

### Step 2: Add email configuration to site.ts

**File**: `src/config/site.ts`

**Changes**:
Add new `email` section to `siteConfig`:

```typescript
export const siteConfig = {
    // ... existing sections ...

    // Email Configuration
    email: {
        fromAddress: 'orders@yeoldeartoonist.com',
        fromName: 'Ye Olde Artoonist',
    },

    // ... rest of config
};
```

**Note**: Admin email will use existing `artist.email` field (`joe@yeoldeartoonist.com`)

**Verification**:

```bash
tsc --noEmit
npx eslint --fix src/config/site.ts
npx prettier --write src/config/site.ts
```

---

### Step 3: Update send.ts to use siteConfig

**File**: `src/lib/email/send.ts`

**Changes**:

1. Import siteConfig at top of file:

    ```typescript
    import { siteConfig } from '@/config/site';
    ```

2. Replace these lines (around line 42-45):

    ```typescript
    // OLD:
    const EMAIL_FROM_ADDRESS =
        process.env.EMAIL_FROM_ADDRESS || 'orders@yeoldeartoonist.com';
    const EMAIL_FROM_NAME = process.env.EMAIL_FROM_NAME || 'Ye Olde Artoonist';
    const ADMIN_EMAIL = process.env.ADMIN_EMAIL || '';

    // NEW:
    const EMAIL_FROM_ADDRESS = siteConfig.email.fromAddress;
    const EMAIL_FROM_NAME = siteConfig.email.fromName;
    const ADMIN_EMAIL = siteConfig.artist.email;
    ```

3. Remove the ADMIN_EMAIL validation check (around line 149-161):
    ```typescript
    // DELETE THIS BLOCK - admin email is always available from siteConfig
    if (!ADMIN_EMAIL) {
        console.warn('ADMIN_EMAIL not configured, skipping admin notification');
        return {
            success: false,
            error: new EmailSendError(
                'ADMIN_EMAIL not configured',
                'CONFIG_ERROR',
                false
            ),
        };
    }
    ```

**Verification**:

```bash
tsc --noEmit
npx eslint --fix src/lib/email/send.ts
npx prettier --write src/lib/email/send.ts
```

---

### Step 4: Update tests to work with siteConfig

**File**: `__tests__/lib/email/send.test.ts`

**Changes**:

1. Remove test cases that check for missing `ADMIN_EMAIL` environment variable (lines ~161-171)
2. Remove test setup that manipulates `ADMIN_EMAIL` environment variable
3. Keep tests that verify `RESEND_API_KEY` validation (still required)
4. All other tests should pass without changes (they test email sending logic, not config source)

**Verification**:

```bash
npx vitest related run __tests__/lib/email/send.test.ts
```

Expected: All tests pass (some removed, remainder unchanged)

---

### Step 5: Remove email variables from .env.example

**File**: `.env.example`

**Changes**:
Remove these lines:

```bash
EMAIL_FROM_ADDRESS="orders@yeoldeartoonist.com"  # FROM address for customer emails
EMAIL_FROM_NAME="Ye Olde Artoonist"
ADMIN_EMAIL="joe@yeoldeartoonist.com"  # TO address for admin order notifications
```

Add a comment explaining the change:

```bash
# Email configuration is in src/config/site.ts
# Only the Resend API key is needed here (actual secret)
```

**Verification**:

```bash
npx prettier --write .env.example
```

---

### Step 6: Manual testing and verification

**Test Scenario 1: Verify refactoring**

1. Remove `ADMIN_EMAIL`, `EMAIL_FROM_ADDRESS`, and `EMAIL_FROM_NAME` from your local `.env.local`
2. Start dev server: `npm run dev`
3. Verify no errors about missing email configuration
4. Application should start successfully

**Test Scenario 2: Test email sending** (requires valid `RESEND_API_KEY`)

1. Ensure `RESEND_API_KEY` is set in `.env.local`
2. Use Stripe CLI to trigger a test webhook OR place a test order
3. Check logs to confirm emails sent
4. Check `joe@yeoldeartoonist.com` inbox for admin notification
5. Verify email has:
    - From: "Ye Olde Artoonist <orders@yeoldeartoonist.com>"
    - To: joe@yeoldeartoonist.com
    - Correct order details

**Test Scenario 3: Run full test suite**

```bash
npm run build:full
```

Expected: All checks pass (type check, lint, tests, build)

---

### Step 7: Create Pull Request

**Branch**: `issue-107`

**PR Title**: `refactor: Move email config to siteConfig (Issue #107)`

**PR Description**:

```markdown
## Summary

Refactors email configuration from environment variables to centralized `siteConfig` for better maintainability and type safety.

**Root Cause**: `ADMIN_EMAIL` environment variable was not configured in production, causing admin notifications to fail silently.

**Solution**: Move all non-secret email configuration to `siteConfig` where it belongs.

## Changes

### Modified Files

- `src/config/site.ts` - Added email configuration section
- `src/lib/email/send.ts` - Refactored to use siteConfig instead of environment variables
- `.env.example` - Removed `ADMIN_EMAIL`, `EMAIL_FROM_ADDRESS`, `EMAIL_FROM_NAME`
- `__tests__/lib/email/send.test.ts` - Removed tests for obsolete environment variables

### Configuration Changes

**Before** (environment variables):

- `ADMIN_EMAIL=joe@yeoldeartoonist.com`
- `EMAIL_FROM_ADDRESS=orders@yeoldeartoonist.com`
- `EMAIL_FROM_NAME=Ye Olde Artoonist`
- `RESEND_API_KEY=<secret>`

**After** (siteConfig + env):

- `siteConfig.artist.email` (already existed)
- `siteConfig.email.fromAddress` (new)
- `siteConfig.email.fromName` (new)
- `RESEND_API_KEY=<secret>` (unchanged)

## Benefits

1. ✅ Eliminates duplication (admin email already in `siteConfig.artist.email`)
2. ✅ Type safety and autocomplete
3. ✅ Centralized configuration
4. ✅ Simpler deployment (3 fewer environment variables)
5. ✅ Email addresses aren't secrets - they belong in code

## Testing

- [x] All existing tests pass
- [x] Manual testing: emails send correctly
- [x] Verified from/to addresses are correct
- [x] Full build passes (`npm run build:full`)

## Deployment Notes

**Before deploying**:

- Remove `ADMIN_EMAIL`, `EMAIL_FROM_ADDRESS`, and `EMAIL_FROM_NAME` from production environment
- Keep `RESEND_API_KEY` (still required)

**After deploying**:

1. Place a test order
2. Verify admin notification arrives at joe@yeoldeartoonist.com
3. Verify from address is orders@yeoldeartoonist.com

## Related Issues

Closes #107
```

---

### Step 8: Merge PR

After PR approval:

```bash
gh pr merge --squash --delete-branch
```

---

## Post-Deployment Verification

### Production Checklist

1. **Remove obsolete environment variables**:
    - [ ] Remove `ADMIN_EMAIL` from production environment
    - [ ] Remove `EMAIL_FROM_ADDRESS` from production environment
    - [ ] Remove `EMAIL_FROM_NAME` from production environment
    - [ ] Keep `RESEND_API_KEY` (still required)

2. **Verify deployment**:
    - [ ] Application starts without errors
    - [ ] No warnings about missing email configuration

3. **Test email delivery**:
    - [ ] Place a test order on production
    - [ ] Verify customer confirmation email sent
    - [ ] Verify admin notification email sent to joe@yeoldeartoonist.com
    - [ ] Verify from address is orders@yeoldeartoonist.com
    - [ ] Verify both emails arrive (not in spam)

4. **Monitor**:
    - [ ] Check application logs for email-related errors
    - [ ] Monitor Resend dashboard for delivery rates
    - [ ] Verify no silent failures

### Troubleshooting

If emails don't arrive after deployment:

1. **Check siteConfig**: Verify `src/config/site.ts` has correct email addresses
2. **Check RESEND_API_KEY**: Ensure it's set in production environment
3. **Check Resend Dashboard**: Verify emails are being sent
4. **Check Spam Folder**: Emails may be filtered initially
5. **Check DNS Records**: Verify SPF/DKIM/DMARC configured at Resend

---

## Summary

This is a straightforward refactoring task that improves configuration architecture while fixing the root cause of the issue.

**Key Points**:

- ✅ Admin notification functionality already works
- ✅ Root cause identified: missing `ADMIN_EMAIL` environment variable
- ✅ Solution: Move email config to `siteConfig` where it belongs
- ✅ Simple refactoring: ~30 lines changed across 4 files
- ✅ Type-safe, maintainable, eliminates duplication
- ✅ Deployment simplified: 3 fewer environment variables

**Estimated Time**: ~30 minutes

**Risk Level**: Low (backward compatible functionality, just changing config source)
